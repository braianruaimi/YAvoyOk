<!DOCTYPE html>
<html lang="es" data-theme="auto">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=5.0, user-scalable=yes">
    <meta name="description"
        content="YAvoy v3.1 Enterprise - Panel Repartidor Pro. Centro de control para repartidores">
    <!-- Theme color compatible repartidores -->
    <meta name="theme-color" content="#667eea">
    <meta name="msapplication-TileColor" content="#667eea">
    <!-- YAvoy Enterprise System -->
    <link rel="stylesheet" href="css/theme-enhancement.css">
    <link rel="stylesheet" href="styles/premium-system.css">
    <script src="js/theme-color-polyfill.js" defer></script>
    <script src="js/intelligent-router.js" defer></script>
    <script src="js/biometric-auth.js" defer></script>
    <title>Panel Repartidor Pro - YaVoy üöÄ</title>

    <link rel="stylesheet" href="styles.css?v=13">
    <link rel="stylesheet" href="styles/theme.css">
    <link rel="stylesheet" href="styles/utilities.css">
    <link rel="stylesheet" href="styles/animations-improved.css?v=1">
    <link rel="stylesheet" href="styles/responsive-improved.css?v=1">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Variables para modo oscuro (default) - Colores YAvoy Principal */
        :root,
        [data-theme="dark"] {
            --color-bg-primary: #020617;
            --color-bg-secondary: #1e293b;
            --color-text-primary: #f8fafc;
            --color-text-secondary: #cbd5e1;
            --color-border-primary: #334155;
            --color-primary: #fbbf24;
            --color-secondary: #f59e0b;
            --accent-gold: #fbbf24;
            --accent-gold-dark: #f59e0b;
        }

        /* Variables para modo claro */
        [data-theme="light"] {
            --color-bg-primary: #ffffff;
            --color-bg-secondary: #f8fafc;
            --color-text-primary: #0f172a;
            --color-text-secondary: #64748b;
            --color-border-primary: #e2e8f0;
            --color-primary: #667eea;
            --color-secondary: #764ba2;
        }

        body {
            font-family: var(--font-family-base);
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-dark) 100%);
            color: #020617;
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .header-title {
            font-size: var(--font-size-2xl);
            font-weight: 700;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #020617;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: var(--font-size-lg);
            transition: all var(--transition-base);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* TOGGLE DISPONIBILIDAD */
        .disponibilidad-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.2);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all var(--transition-base);
            user-select: none;
        }

        .disponibilidad-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-full);
            transition: background 0.3s;
        }

        .toggle-switch.activo {
            background: #10b981;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.activo .toggle-slider {
            transform: translateX(24px);
        }

        .toggle-label {
            font-weight: 600;
            font-size: var(--font-size-sm);
        }

        /* LOGIN MODAL */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-modal {
            background: var(--color-bg-secondary);
            padding: var(--spacing-2xl);
            border-radius: var(--radius-lg);
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .login-modal h2 {
            color: var(--accent-gold);
            margin-bottom: var(--spacing-lg);
            text-align: center;
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-sm);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        .form-group input {
            width: 100%;
            padding: var(--spacing-md);
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border-primary);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: var(--font-size-base);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .btn-login {
            width: 100%;
            padding: var(--spacing-md);
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-dark) 100%);
            color: #020617;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: var(--font-size-base);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-login:hover {
            transform: translateY(-2px);
        }

        .login-error {
            background: #fee2e2;
            color: #991b1b;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-sm);
            font-size: var(--font-size-sm);
            display: none;
        }

        /* CARRUSEL COMERCIOS */
        .comercios-section {
            margin-top: var(--spacing-2xl);
            padding: var(--spacing-xl);
            background: var(--color-bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border-primary);
        }

        .comercios-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
        }

        .comercios-header h2 {
            margin: 0;
            color: var(--accent-gold);
        }

        .btn-ver-mas {
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-dark) 100%);
            color: #020617;
            border: none;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-full);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            transition: transform 0.2s;
        }

        .btn-ver-mas:hover {
            transform: translateY(-2px);
        }

        .comercios-carousel {
            position: relative;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .carousel-container {
            overflow: hidden;
            flex: 1;
        }

        .carousel-track {
            display: flex;
            gap: var(--spacing-lg);
            transition: transform 0.3s ease;
        }

        .comercio-card {
            min-width: 280px;
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            cursor: pointer;
            transition: all 0.3s;
        }

        .comercio-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-gold);
            box-shadow: 0 10px 30px rgba(251, 191, 36, 0.2);
        }

        .comercio-card-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .comercio-avatar {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .comercio-info h3 {
            margin: 0 0 var(--spacing-xs) 0;
            color: var(--color-text-primary);
            font-size: var(--font-size-lg);
        }

        .comercio-categoria {
            color: var(--color-text-tertiary);
            font-size: var(--font-size-sm);
        }

        .comercio-stats {
            display: flex;
            gap: var(--spacing-lg);
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--color-border-primary);
        }

        .comercio-stat {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .comercio-stat-value {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--accent-gold);
        }

        .comercio-stat-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-tertiary);
        }

        .comercio-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .carousel-btn {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border-primary);
            color: var(--color-text-primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .carousel-btn:hover {
            background: var(--accent-gold);
            color: #020617;
            border-color: var(--accent-gold);
        }

        .carousel-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* MODAL COMERCIOS FLOTANTE */
        .modal-comercios {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            padding: var(--spacing-xl);
            overflow-y: auto;
        }

        .modal-comercios.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-comercios-content {
            background: var(--color-bg-secondary);
            border-radius: var(--radius-lg);
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        .modal-comercios-header {
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--color-border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-comercios-header h2 {
            margin: 0;
            color: var(--accent-gold);
        }

        .btn-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--color-text-primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .modal-comercios-body {
            padding: var(--spacing-xl);
            overflow-y: auto;
        }

        .comercios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-lg);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* NAVIGATION TABS */
        .nav-tabs {
            background-color: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border-primary);
            display: flex;
            gap: var(--spacing-lg);
            padding: var(--spacing-md) var(--spacing-lg);
            max-width: 1400px;
            margin: 0 auto;
            overflow-x: auto;
            position: sticky;
            top: 70px;
            z-index: 50;
        }

        .nav-tab {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            font-size: var(--font-size-base);
            font-weight: 600;
            transition: all var(--transition-base);
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .nav-tab:hover {
            color: var(--color-primary);
        }

        .nav-tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        /* MAIN CONTAINER */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        /* TAB CONTENT */
        .tab-content {
            display: none;
            animation: slideInUp var(--transition-base) ease-out;
        }

        .tab-content.active {
            display: block;
        }

        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }

        .stat-card {
            background-color: var(--color-bg-secondary);
            border: 1px solid var(--color-border-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            transition: all var(--transition-base);
        }

        .stat-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-md);
        }

        .stat-label {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-sm);
        }

        .stat-value {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--color-primary);
        }

        .stat-change {
            font-size: var(--font-size-sm);
            color: var(--color-success);
            margin-top: var(--spacing-sm);
        }

        /* RATING BADGE */
        .rating-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            font-weight: 700;
            font-size: var(--font-size-lg);
        }

        .stars {
            display: flex;
            gap: var(--spacing-xs);
        }

        .star {
            font-size: var(--font-size-lg);
            color: #fbbf24;
        }

        /* ACHIEVEMENTS */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: var(--spacing-md);
            margin: var(--spacing-2xl) 0;
        }

        .achievement {
            background-color: var(--color-bg-secondary);
            border: 2px solid var(--color-border-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            text-align: center;
            transition: all var(--transition-base);
            cursor: pointer;
        }

        .achievement.locked {
            opacity: 0.5;
            filter: grayscale(100%);
        }

        .achievement:hover:not(.locked) {
            border-color: var(--color-primary);
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .achievement-icon {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-sm);
        }

        .achievement-name {
            font-size: var(--font-size-sm);
            font-weight: 600;
            margin: var(--spacing-sm) 0;
        }

        .achievement-progress {
            height: 4px;
            background-color: var(--color-border-primary);
            border-radius: var(--radius-full);
            margin-top: var(--spacing-sm);
            overflow: hidden;
        }

        .achievement-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
            transition: width var(--transition-slow);
        }

        /* MAP CONTAINER */
        .map-container {
            height: 500px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            margin: var(--spacing-2xl) 0;
            border: 1px solid var(--color-border-primary);
        }

        /* ORDERS LIST */
        .orders-list {
            display: grid;
            gap: var(--spacing-md);
        }

        .order-card {
            background-color: var(--color-bg-secondary);
            border: 1px solid var(--color-border-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            transition: all var(--transition-base);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .order-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-lg);
        }

        .order-info {
            flex: 1;
        }

        .order-id {
            font-weight: 700;
            font-size: var(--font-size-lg);
            color: var(--color-text-primary);
        }

        .order-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .order-detail {
            font-size: var(--font-size-sm);
        }

        .order-detail-label {
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .order-status {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: 600;
            white-space: nowrap;
        }

        .status-active {
            background-color: var(--color-info-light);
            color: var(--color-info);
        }

        .status-completed {
            background-color: var(--color-success-light);
            color: var(--color-success);
        }

        .status-cancelled {
            background-color: var(--color-danger-light);
            color: var(--color-danger);
        }

        /* BUTTONS */
        .btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-lg);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: var(--font-size-base);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--color-primary);
            color: var(--color-primary);
        }

        .btn-outline:hover {
            background: var(--color-primary-lighter);
        }

        /* MODALS */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--color-bg-overlay);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn var(--transition-base);
        }

        .modal {
            background: var(--color-bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-2xl);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-2xl);
            animation: slideInUp var(--transition-base);
        }

        .modal-close {
            position: absolute;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            background: none;
            border: none;
            font-size: var(--font-size-2xl);
            color: var(--color-text-secondary);
            cursor: pointer;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .nav-tabs {
                gap: var(--spacing-sm);
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .order-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .achievements-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* ANIMATIONS */
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Carga */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-3xl);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-border-primary);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- LOGIN OVERLAY -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-modal">
            <h2>üöö Ya Voy Pro - Repartidor</h2>
            <form id="loginForm" onsubmit="return validarLogin(event)">
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">Contrase√±a</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn-login">Ingresar</button>
                <div class="login-error" id="loginError">Usuario o contrase√±a incorrectos</div>
            </form>
        </div>
    </div>

    <!-- HEADER -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-title">üöÄ YaVoy Pro</div>
                <button class="theme-toggle" id="themeToggle">üåô</button>
            </div>
            <div class="header-right">
                <!-- TOGGLE DISPONIBILIDAD -->
                <div class="disponibilidad-toggle" onclick="toggleDisponibilidad()">
                    <span class="toggle-label" id="toggleLabel">ACTIVO</span>
                    <div class="toggle-switch activo" id="toggleSwitch">
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="statusText">Conectado</span>
                </div>
                <div id="userInfo" class="text-white"></div>
            </div>
        </div>
    </header>

    <!-- NAVIGATION TABS -->
    <nav class="nav-tabs">
        <button class="nav-tab active" data-tab="dashboard">üìä Dashboard</button>
        <button class="nav-tab" data-tab="orders">üì¶ Mis Pedidos</button>
        <button class="nav-tab" data-tab="map">üó∫Ô∏è Mapa</button>
        <button class="nav-tab" data-tab="ratings">‚≠ê Mi Reputaci√≥n</button>
        <button class="nav-tab" data-tab="achievements">üèÜ Logros</button>
        <button class="nav-tab" data-tab="settings">‚öôÔ∏è Configuraci√≥n</button>
    </nav>

    <!-- MAIN CONTAINER -->
    <div class="container">
        <!-- TAB: DASHBOARD -->
        <div class="tab-content active" id="dashboard">
            <h2 class="mb-lg">Bienvenido, <span id="repartidorNombre">Repartidor</span> üëã</h2>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-label">Pedidos Hoy</div>
                    <div class="stat-value" id="pedidosHoy">0</div>
                    <div class="stat-change">+2 respecto a ayer</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-label">Ganancias Hoy</div>
                    <div class="stat-value" id="gananciasHoy">$0</div>
                    <div class="stat-change">Promedio: $150/d√≠a</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-label">Tiempo Promedio</div>
                    <div class="stat-value" id="tiempoPromedio">25 min</div>
                    <div class="stat-change">Meta: 30 min</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-label">Tasa de √âxito</div>
                    <div class="stat-value" id="tasaExito">98%</div>
                    <div class="stat-change">Objetivo: 99%</div>
                </div>
            </div>

            <h3 class="my-2xl mb-lg">Tu Calificaci√≥n üåü</h3>
            <div class="rating-display">
                <div class="stars">
                    <span class="star">‚≠ê</span>
                    <span class="star">‚≠ê</span>
                    <span class="star">‚≠ê</span>
                    <span class="star">‚≠ê</span>
                    <span class="star">‚≠ê</span>
                </div>
                <span id="ratingValue">5.0</span>
                <span>(<span id="ratingCount">42</span> rese√±as)</span>
            </div>

            <div class="order-details mt-lg p-lg bg-secondary rounded-lg">
                <div class="order-detail">
                    <div class="order-detail-label">Puntualidad</div>
                    <div class="font-bold">4.9/5 ‚ö°</div>
                </div>
                <div class="order-detail">
                    <div class="order-detail-label">Amabilidad</div>
                    <div class="font-bold">5.0/5 üòä</div>
                </div>
                <div class="order-detail">
                    <div class="order-detail-label">Limpieza</div>
                    <div class="font-bold">4.8/5 üßπ</div>
                </div>
                <div class="order-detail">
                    <div class="order-detail-label">Exactitud</div>
                    <div class="font-bold">5.0/5 ‚úÖ</div>
                </div>
            </div>

            <!-- CARRUSEL DE COMERCIOS ACTIVOS -->
            <div class="comercios-section">
                <div class="comercios-header">
                    <h2>üè™ Comercios Activos</h2>
                    <button class="btn-ver-mas" onclick="abrirModalComercios()">
                        Ver Todos <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="comercios-carousel" id="comerciosCarousel">
                    <button class="carousel-btn prev" onclick="moverCarrusel(-1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="carousel-container">
                        <div class="carousel-track" id="carouselTrack">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                    <button class="carousel-btn next" onclick="moverCarrusel(1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB: MIS PEDIDOS -->
        <div class="tab-content" id="orders">
            <h2 class="mb-lg">Mis Pedidos</h2>
            <div class="orders-list" id="ordersList">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- TAB: MAPA -->
        <div class="tab-content" id="map">
            <h2 class="mb-lg">Rastreo en Tiempo Real üó∫Ô∏è</h2>
            <div class="map-container" id="mapContainer">
                <div class="w-full h-full d-flex align-center justify-center bg-secondary">
                    <p>Cargando mapa...</p>
                </div>
            </div>
            <div class="mt-lg p-lg bg-secondary rounded-lg">
                <button class="btn btn-primary w-full mb-md"
                    onclick="geoManager?.startTracking('REP-01', 'repartidor')">
                    üìç Iniciar Rastreo
                </button>
                <button class="btn btn-outline w-full" onclick="geoManager?.stopTracking()">
                    ‚èπÔ∏è Detener Rastreo
                </button>
            </div>
        </div>

        <!-- TAB: MI REPUTACI√ìN -->
        <div class="tab-content" id="ratings">
            <h2 class="mb-lg">Mi Reputaci√≥n ‚≠ê</h2>
            <div id="ratingsList">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- MODAL COMERCIOS FLOTANTE -->
        <div class="modal-comercios" id="modalComercios" onclick="cerrarModalComercios(event)">
            <div class="modal-comercios-content" onclick="event.stopPropagation()">
                <div class="modal-comercios-header">
                    <h2>üè™ Todos los Comercios Activos</h2>
                    <button class="btn-close" onclick="cerrarModalComercios()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-comercios-body" id="modalComerciosBody">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>
        </div>

        <!-- TAB: LOGROS -->
        <div class="tab-content" id="achievements">
            <h2 class="mb-lg">Mis Logros üèÜ</h2>
            <div class="achievements-grid" id="achievementsList">
                <!-- Se llena din√°micamente -->
            </div>
        </div>

        <!-- TAB: CONFIGURACI√ìN -->
        <div class="tab-content" id="settings">
            <h2 class="mb-lg">Configuraci√≥n ‚öôÔ∏è</h2>
            <div class="d-grid gap-lg">
                <div class="p-lg bg-secondary rounded-lg">
                    <h3 class="mb-md">Notificaciones</h3>
                    <label class="d-flex align-center gap-md cursor-pointer">
                        <input type="checkbox" checked>
                        <span>Recibir notificaciones de nuevos pedidos</span>
                    </label>
                </div>

                <div class="p-lg bg-secondary rounded-lg">
                    <h3 class="mb-md">Privacidad</h3>
                    <label class="d-flex align-center gap-md cursor-pointer">
                        <input type="checkbox" checked>
                        <span>Permitir rastreo de ubicaci√≥n</span>
                    </label>
                </div>

                <div class="p-lg bg-secondary rounded-lg">
                    <h3 class="mb-md">Documentos</h3>
                    <button class="btn btn-outline">üìÑ Descargar Comprobantes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/theme.js"></script>
    <script src="js/geo.js"></script>
    <script src="js/ratings.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        // NAVEGACI√ìN DE TABS
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                document.querySelectorAll('.nav-tab').forEach(t => {
                    t.classList.remove('active');
                });

                document.getElementById(tabName).classList.add('active');
                tab.classList.add('active');
            });
        });

        // THEME TOGGLE
        const themeToggle = document.getElementById('themeToggle');
        
        // Cargar tema guardado o usar oscuro por defecto
        const savedTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(savedTheme);
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        });

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            // Actualizar icono
            const icon = document.getElementById('themeToggle');
            icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            icon.title = theme === 'dark' ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro';
            
            console.log('‚úÖ Tema cambiado a:', theme);
        }

        // Socket.IO
        const socket = io('http://localhost:5501');

        // Obtener datos del repartidor autenticado
        const repartidorActual = JSON.parse(localStorage.getItem('currentUser') || '{}');
        const repartidorId = repartidorActual.id || 'REP-DEMO';
        const repartidorCiudad = repartidorActual.ciudad || 'C√≥rdoba';

        socket.on('connect', () => {
            console.log('‚úÖ Conectado');
            socket.emit('registrar', {
                userId: repartidorId,
                tipo: 'repartidor',
                ciudad: repartidorCiudad,
                ubicacion: {
                    lat: repartidorActual.ubicacionLat || -31.4201,
                    lng: repartidorActual.ubicacionLng || -64.1888
                }
            });
            document.getElementById('statusText').textContent = 'Conectado';
        });

        socket.on('disconnect', () => {
            document.getElementById('statusText').textContent = 'Desconectado';
        });

        // Inicializar Google Maps (requiere API KEY)
        function initializeMap() {
            if (typeof google !== 'undefined' && google.maps) {
                const geoConfig = {
                    socket: socket,
                    updateInterval: 10000
                };
                geoManager = new GeoLocationManager(geoConfig);
                geoManager.initMap('mapContainer');
            }
        }

        // üöÄ SISTEMA DE PEDIDOS REPARTIDOR
        let pedidosDisponibles = [];
        let pedidosActivos = [];
        let pedidosCompletados = [];
        let gananciasTotales = {
            hoy: 0,
            semana: 0,
            mes: 0
        };

        // Cargar pedidos desde localStorage o API
        async function cargarPedidos() {
            try {
                // Intentar cargar desde API
                const response = await fetch('http://localhost:5501/api/listar-pedidos');
                if (response.ok) {
                    const data = await response.json();
                    procesarPedidos(data.pedidos || []);
                } else {
                    // Fallback a localStorage
                    const pedidosLocal = JSON.parse(localStorage.getItem('pedidos')) || [];
                    procesarPedidos(pedidosLocal);
                }
            } catch (error) {
                console.error('Error cargando pedidos:', error);
                // Fallback a localStorage
                const pedidosLocal = JSON.parse(localStorage.getItem('pedidos')) || [];
                procesarPedidos(pedidosLocal);
            }
        }

        function procesarPedidos(pedidos) {
            pedidosDisponibles = pedidos.filter(p => p.estado === 'pendiente' && !p.repartidor);
            pedidosActivos = pedidos.filter(p => p.repartidor === repartidorId && ['aceptado', 'en_camino'].includes(p.estado));
            pedidosCompletados = pedidos.filter(p => p.repartidor === repartidorId && p.estado === 'entregado');
            
            calcularGanancias();
            renderizarPedidos();
        }

        function renderizarPedidos() {
            // Renderizar pedidos activos
            const activosHTML = pedidosActivos.length > 0 ? pedidosActivos.map(pedido => `
                <div class="order-card" data-pedido-id="${pedido.id}">
                    <div class="order-info">
                        <div class="order-id">${pedido.numero}</div>
                        <div class="order-details">
                            <div class="order-detail">
                                <div class="order-detail-label">üìç Direcci√≥n</div>
                                <div>${pedido.direccion || 'Sin direcci√≥n'}</div>
                            </div>
                            <div class="order-detail">
                                <div class="order-detail-label">üí∞ Monto Total</div>
                                <div>$${pedido.total}</div>
                            </div>
                            <div class="order-detail">
                                <div class="order-detail-label">üíµ Tu Ganancia (80%)</div>
                                <div style="color: #10b981; font-weight: 700;">$${(pedido.total * 0.8).toFixed(2)}</div>
                            </div>
                            <div class="order-detail">
                                <div class="order-detail-label">üìû Cliente</div>
                                <div>${pedido.telefono || 'Sin tel√©fono'}</div>
                            </div>
                            <div class="order-detail">
                                <div class="order-detail-label">üïê Hora</div>
                                <div>${new Date(pedido.fecha).toLocaleTimeString('es-AR')}</div>
                            </div>
                        </div>
                    </div>
                    <div class="order-status ${pedido.estado === 'en_camino' ? 'status-active' : 'status-pending'}">
                        ${pedido.estado === 'aceptado' ? 'üì¶ Listo para recoger' : 'üöó En camino'}
                    </div>
                    <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                        ${pedido.estado === 'aceptado' ? `
                            <button onclick="marcarEnCamino('${pedido.id}')" class="btn btn-primary" style="flex: 1;">
                                üöó Marcar En Camino
                            </button>
                        ` : `
                            <button onclick="marcarEntregado('${pedido.id}')" class="btn btn-success" style="flex: 1;">
                                ‚úÖ Marcar Entregado
                            </button>
                        `}
                        <button onclick="abrirNavegacion('${pedido.direccion}')" class="btn btn-outline" style="flex: 1;">
                            üó∫Ô∏è Navegar
                        </button>
                    </div>
                </div>
            `).join('') : '<p style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-secondary);">No tienes pedidos activos</p>';
            
            document.getElementById('ordersList').innerHTML = activosHTML;

            // Renderizar pedidos disponibles (para tab correspondiente)
            renderizarPedidosDisponibles();
            
            // Cargar calificaciones
            const ratingsHTML = `
                <div class="order-card" style="flex-direction: column; align-items: flex-start;">
                    <div style="display: flex; align-items: center; gap: var(--spacing-md); width: 100%; margin-bottom: var(--spacing-md);">
                        <div style="font-size: 2rem;">üë§</div>
                        <div>
                            <div style="font-weight: 700;">Juan Garc√≠a</div>
                            <div class="stars">
                                <span class="star">‚≠ê</span>
                                <span class="star">‚≠ê</span>
                                <span class="star">‚≠ê</span>
                                <span class="star">‚≠ê</span>
                                <span class="star">‚≠ê</span>
                            </div>
                        </div>
                    </div>
                    <p>"¬°Excelente servicio! Lleg√≥ r√°pido y en perfectas condiciones. Muy amable el repartidor."</p>
                    <div style="color: var(--color-text-tertiary); font-size: var(--font-size-sm); margin-top: var(--spacing-md);">Hace 2 d√≠as</div>
                </div>
            `;
            document.getElementById('ratingsList').innerHTML = ratingsHTML;
        }

        function renderizarPedidosDisponibles() {
            const contenedor = document.querySelector('#disponibles .stat-grid');
            if (!contenedor) return;

            if (pedidosDisponibles.length === 0) {
                contenedor.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: var(--spacing-xl); color: var(--color-text-secondary);">No hay pedidos disponibles en este momento</p>';
                return;
            }

            contenedor.innerHTML = pedidosDisponibles.map(pedido => `
                <div class="order-card" data-pedido-id="${pedido.id}" style="animation: slideIn 0.3s ease;">
                    <div class="order-info">
                        <div class="order-id">${pedido.numero}</div>
                        <div class="order-details">
                            <div class="order-detail">
                                <div class="order-detail-label">üè™ Comercio</div>
                                <div>${pedido.comercio || 'Sin especificar'}</div>
                            </div>
                            <div class="order-detail">
                                <div class="order-detail-label">üìç Destino</div>
                                <div>${pedido.direccion || 'Sin direcci√≥n'}</div>
                            </div>
                            <div class="order-detail">
                                <div class="order-detail-label">üí∞ Monto</div>
                                <div>$${pedido.total}</div>
                            </div>
                            <div class="order-detail">
                                <div class="order-detail-label">üíµ Ganar√°s</div>
                                <div style="color: #10b981; font-weight: 700; font-size: 1.2rem;">$${(pedido.total * 0.8).toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                    <button onclick="aceptarPedido('${pedido.id}')" class="btn btn-primary" style="width: 100%; margin-top: var(--spacing-md);">
                        ‚úÖ Aceptar Pedido
                    </button>
                </div>
            `).join('');
        }

        async function aceptarPedido(pedidoId) {
            try {
                const pedido = pedidosDisponibles.find(p => p.id === pedidoId);
                if (!pedido) return;

                pedido.repartidor = repartidorId;
                pedido.estado = 'aceptado';
                pedido.fechaAceptado = new Date().toISOString();

                // Guardar en localStorage
                const todosPedidos = JSON.parse(localStorage.getItem('pedidos')) || [];
                const index = todosPedidos.findIndex(p => p.id === pedidoId);
                if (index !== -1) {
                    todosPedidos[index] = pedido;
                    localStorage.setItem('pedidos', JSON.stringify(todosPedidos));
                }

                // Enviar a API
                await fetch('http://localhost:5501/api/guardar-pedidos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pedidos: todosPedidos })
                });

                // Notificar via Socket.IO
                socket.emit('pedido-aceptado', {
                    pedidoId,
                    repartidorId,
                    repartidorNombre: repartidorActual.nombre || 'Repartidor'
                });

                mostrarNotificacion('‚úÖ Pedido aceptado correctamente', 'success');
                await cargarPedidos();

            } catch (error) {
                console.error('Error aceptando pedido:', error);
                mostrarNotificacion('‚ùå Error al aceptar el pedido', 'error');
            }
        }

        async function marcarEnCamino(pedidoId) {
            await cambiarEstadoPedido(pedidoId, 'en_camino', 'üöó Pedido marcado como en camino');
        }

        async function marcarEntregado(pedidoId) {
            await cambiarEstadoPedido(pedidoId, 'entregado', '‚úÖ Pedido entregado exitosamente');
        }

        async function cambiarEstadoPedido(pedidoId, nuevoEstado, mensaje) {
            try {
                const todosPedidos = JSON.parse(localStorage.getItem('pedidos')) || [];
                const pedido = todosPedidos.find(p => p.id === pedidoId);
                
                if (!pedido) return;

                pedido.estado = nuevoEstado;
                pedido[`fecha${nuevoEstado.charAt(0).toUpperCase() + nuevoEstado.slice(1)}`] = new Date().toISOString();

                localStorage.setItem('pedidos', JSON.stringify(todosPedidos));

                await fetch('http://localhost:5501/api/guardar-pedidos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pedidos: todosPedidos })
                });

                socket.emit('pedido-actualizado', { pedidoId, estado: nuevoEstado });

                mostrarNotificacion(mensaje, 'success');
                await cargarPedidos();

            } catch (error) {
                console.error('Error cambiando estado:', error);
                mostrarNotificacion('‚ùå Error al actualizar el pedido', 'error');
            }
        }

        function calcularGanancias() {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            const semanaAtras = new Date();
            semanaAtras.setDate(semanaAtras.getDate() - 7);
            
            const mesAtras = new Date();
            mesAtras.setMonth(mesAtras.getMonth() - 1);

            gananciasTotales = {
                hoy: 0,
                semana: 0,
                mes: 0
            };

            pedidosCompletados.forEach(pedido => {
                const ganancia = pedido.total * 0.8;
                const fechaPedido = new Date(pedido.fechaEntregado || pedido.fecha);
                
                if (fechaPedido >= mesAtras) {
                    gananciasTotales.mes += ganancia;
                    
                    if (fechaPedido >= semanaAtras) {
                        gananciasTotales.semana += ganancia;
                        
                        if (fechaPedido >= hoy) {
                            gananciasTotales.hoy += ganancia;
                        }
                    }
                }
            });

            actualizarDashboard();
        }

        function actualizarDashboard() {
            // Actualizar stats del header
            const statsHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700;">$${gananciasTotales.hoy.toFixed(2)}</div>
                    <div style="opacity: 0.9;">Hoy</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700;">${pedidosActivos.length}</div>
                    <div style="opacity: 0.9;">Activos</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700;">${pedidosCompletados.length}</div>
                    <div style="opacity: 0.9;">Completados</div>
                </div>
            `;
            const statsContainer = document.querySelector('.header-right > div:first-child');
            if (statsContainer) {
                statsContainer.innerHTML = statsHTML;
            }
        }

        // üìç TRACKING GPS EN TIEMPO REAL
        let watchId = null;
        let ubicacionActual = { lat: null, lng: null };

        function iniciarTracking() {
            if (!navigator.geolocation) {
                mostrarNotificacion('‚ùå Tu navegador no soporta geolocalizaci√≥n', 'error');
                return;
            }

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    ubicacionActual = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        timestamp: new Date().toISOString()
                    };

                    // Enviar ubicaci√≥n al servidor
                    socket.emit('actualizar-ubicacion-repartidor', {
                        repartidorId,
                        ubicacion: ubicacionActual
                    });

                    console.log('üìç Ubicaci√≥n actualizada:', ubicacionActual);
                },
                (error) => {
                    console.error('Error obteniendo ubicaci√≥n:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );

            mostrarNotificacion('üìç Tracking GPS activado', 'success');
        }

        function detenerTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                mostrarNotificacion('üìç Tracking GPS desactivado', 'info');
            }
        }

        function abrirNavegacion(direccion) {
            if (ubicacionActual.lat && ubicacionActual.lng) {
                const url = `https://www.google.com/maps/dir/?api=1&origin=${ubicacionActual.lat},${ubicacionActual.lng}&destination=${encodeURIComponent(direccion)}&travelmode=driving`;
                window.open(url, '_blank');
            } else {
                const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(direccion)}`;
                window.open(url, '_blank');
            }
        }

        function mostrarNotificacion(mensaje, tipo = 'info') {
            const colores = {
                success: '#10b981',
                error: '#ef4444',
                info: '#667eea',
                warning: '#f59e0b'
            };

            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${colores[tipo]};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notif.textContent = mensaje;
            document.body.appendChild(notif);

            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // Escuchar nuevos pedidos desde Socket.IO
        socket.on('nuevo-pedido-disponible', (pedido) => {
            mostrarNotificacion(`üîî Nuevo pedido disponible: $${(pedido.total * 0.8).toFixed(2)}`, 'success');
            cargarPedidos();
        });

        // Escuchar nuevos comercios activos
        socket.on('nuevo-comercio-registrado', (comercio) => {
            console.log('Nuevo comercio registrado:', comercio);
            
            // Verificar si el comercio ya existe
            const existe = comerciosActivos.find(c => c.id === comercio.id);
            if (!existe && comercio.activo) {
                comerciosActivos.push(comercio);
                localStorage.setItem('comerciosActivos', JSON.stringify(comerciosActivos));
                renderizarComerciosCarrusel();
                mostrarNotificacion(`üè™ Nuevo comercio disponible: ${comercio.nombre}`, 'success');
            }
        });

        // Escuchar actualizaci√≥n de estado de comercio
        socket.on('comercio-estado-actualizado', (data) => {
            console.log('Estado comercio actualizado:', data);
            actualizarEstadoComercio(data.comercioId, data.activo);
        });

        // ============================
        // SISTEMA DE LOGIN
        // ============================
        function validarLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            // Validar credenciales
            if (username === 'repartidor001' && password === 'contrase√±a123') {
                // Guardar sesi√≥n
                const usuario = {
                    id: 'REP-001',
                    nombre: 'Repartidor 001',
                    username: username,
                    disponible: true,
                    gananciasPorcentaje: 80
                };
                
                localStorage.setItem('currentUser', JSON.stringify(usuario));
                localStorage.setItem('isLoggedIn', 'true');
                
                // Ocultar overlay de login
                document.getElementById('loginOverlay').style.display = 'none';
                
                // Inicializar panel
                actualizarInfoUsuario();
                cargarPedidos();
                iniciarTracking();
                
                // Cargar y renderizar comercios
                comerciosActivos = cargarComerciosActivos();
                renderizarComerciosCarrusel();
                
                mostrarNotificacion('‚úÖ Bienvenido al panel Ya Voy Pro', 'success');
            } else {
                // Mostrar error
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
            
            return false;
        }

        function actualizarInfoUsuario() {
            const usuario = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const userInfo = document.getElementById('userInfo');
            if (usuario.nombre) {
                userInfo.textContent = `üë§ ${usuario.nombre}`;
            }
        }

        function verificarSesion() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const loginOverlay = document.getElementById('loginOverlay');
            
            if (isLoggedIn === 'true') {
                loginOverlay.style.display = 'none';
                actualizarInfoUsuario();
                
                // Cargar comercios cuando la sesi√≥n est√° verificada
                setTimeout(() => {
                    comerciosActivos = cargarComerciosActivos();
                    renderizarComerciosCarrusel();
                }, 100);
            } else {
                loginOverlay.style.display = 'flex';
            }
        }

        // ============================
        // TOGGLE DISPONIBILIDAD
        // ============================
        function toggleDisponibilidad() {
            const usuario = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const disponible = !usuario.disponible;
            
            usuario.disponible = disponible;
            localStorage.setItem('currentUser', JSON.stringify(usuario));
            
            const toggleSwitch = document.getElementById('toggleSwitch');
            const toggleLabel = document.getElementById('toggleLabel');
            
            if (disponible) {
                toggleSwitch.classList.add('activo');
                toggleLabel.textContent = 'ACTIVO';
                mostrarNotificacion('‚úÖ Ahora est√°s disponible para recibir pedidos', 'success');
            } else {
                toggleSwitch.classList.remove('activo');
                toggleLabel.textContent = 'INACTIVO';
                mostrarNotificacion('‚è∏Ô∏è Ahora est√°s inactivo, no recibir√°s pedidos nuevos', 'info');
            }
            
            // Emitir evento Socket.IO
            socket.emit('cambiar-disponibilidad', {
                repartidorId: usuario.id,
                disponible: disponible
            });
        }

        // Funci√≥n para cerrar sesi√≥n
        function cerrarSesion() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('isLoggedIn');
            location.reload();
        }

        // ============================
        // CARRUSEL DE COMERCIOS
        // ============================
        
        // Comercios por defecto
        const comerciosDefault = [
            {
                id: 1,
                nombre: 'Pizza Palace',
                categoria: 'Restaurante',
                emoji: 'üçï',
                rating: 4.8,
                pedidosHoy: 24,
                distancia: 1.2,
                activo: true
            },
            {
                id: 2,
                nombre: 'Burger King',
                categoria: 'Comida R√°pida',
                emoji: 'üçî',
                rating: 4.6,
                pedidosHoy: 18,
                distancia: 0.8,
                activo: true
            },
            {
                id: 3,
                nombre: 'Sushi Bar',
                categoria: 'Japon√©s',
                emoji: 'üç±',
                rating: 4.9,
                pedidosHoy: 15,
                distancia: 2.1,
                activo: true
            },
            {
                id: 4,
                nombre: 'Caf√© Central',
                categoria: 'Cafeter√≠a',
                emoji: '‚òï',
                rating: 4.7,
                pedidosHoy: 32,
                distancia: 0.5,
                activo: true
            },
            {
                id: 5,
                nombre: 'Tacos Mexicanos',
                categoria: 'Mexicano',
                emoji: 'üåÆ',
                rating: 4.5,
                pedidosHoy: 21,
                distancia: 1.8,
                activo: true
            },
            {
                id: 6,
                nombre: 'Parrilla Argentina',
                categoria: 'Parrilla',
                emoji: 'ü•©',
                rating: 4.9,
                pedidosHoy: 19,
                distancia: 2.5,
                activo: true
            },
            {
                id: 7,
                nombre: 'Pasta Italiana',
                categoria: 'Italiano',
                emoji: 'üçù',
                rating: 4.7,
                pedidosHoy: 16,
                distancia: 1.4,
                activo: true
            },
            {
                id: 8,
                nombre: 'Helader√≠a Cremosa',
                categoria: 'Postres',
                emoji: 'üç¶',
                rating: 4.8,
                pedidosHoy: 28,
                distancia: 0.9,
                activo: true
            }
        ];

        let carruselPosicion = 0;

        // Cargar comercios desde localStorage o usar defaults
        function cargarComerciosActivos() {
            const comerciosGuardados = localStorage.getItem('comerciosActivos');
            if (comerciosGuardados) {
                try {
                    const comercios = JSON.parse(comerciosGuardados);
                    console.log('Comercios cargados del localStorage:', comercios);
                    return comercios.filter(c => c.activo === true);
                } catch (e) {
                    console.error('Error al cargar comercios:', e);
                    return comerciosDefault;
                }
            } else {
                console.log('No hay comercios guardados, usando defaults');
                // Guardar comercios por defecto
                localStorage.setItem('comerciosActivos', JSON.stringify(comerciosDefault));
                return comerciosDefault;
            }
        }

        let comerciosActivos = cargarComerciosActivos();
        console.log('Comercios activos iniciales:', comerciosActivos);

        // Funci√≥n para agregar nuevo comercio
        function agregarNuevoComercio(comercio) {
            // Cargar todos los comercios del localStorage
            const todosLosComercios = JSON.parse(localStorage.getItem('comerciosActivos') || '[]');
            
            // Generar ID √∫nico
            const maxId = todosLosComercios.length > 0 ? Math.max(...todosLosComercios.map(c => c.id), 0) : 0;
            comercio.id = maxId + 1;
            comercio.activo = true;
            comercio.pedidosHoy = 0;
            
            // Agregar al array de todos los comercios
            todosLosComercios.push(comercio);
            
            // Guardar TODOS los comercios en localStorage
            localStorage.setItem('comerciosActivos', JSON.stringify(todosLosComercios));
            console.log('Comercio agregado:', comercio);
            console.log('Total comercios guardados:', todosLosComercios.length);
            
            // Recargar comercios activos
            comerciosActivos = cargarComerciosActivos();
            
            // Actualizar vista
            renderizarComerciosCarrusel();
            
            // Mostrar notificaci√≥n
            mostrarNotificacion(`‚úÖ Nuevo comercio agregado: ${comercio.nombre}`, 'success');
            
            // Emitir evento Socket.io
            socket.emit('nuevo-comercio-activo', comercio);
            
            return comercio;
        }

        // Funci√≥n para actualizar estado de comercio
        function actualizarEstadoComercio(comercioId, activo) {
            const index = comerciosActivos.findIndex(c => c.id === comercioId);
            if (index !== -1) {
                comerciosActivos[index].activo = activo;
                localStorage.setItem('comerciosActivos', JSON.stringify(comerciosActivos));
                
                // Recargar solo comercios activos
                comerciosActivos = cargarComerciosActivos();
                renderizarComerciosCarrusel();
                
                const estado = activo ? 'activado' : 'desactivado';
                mostrarNotificacion(`Comercio ${comerciosActivos[index].nombre} ${estado}`, 'info');
            }
        }

        // Funci√≥n para eliminar comercio
        function eliminarComercio(comercioId) {
            const index = comerciosActivos.findIndex(c => c.id === comercioId);
            if (index !== -1) {
                const nombreComercio = comerciosActivos[index].nombre;
                comerciosActivos.splice(index, 1);
                
                // Actualizar localStorage con todos los comercios
                const todosLosComercios = JSON.parse(localStorage.getItem('comerciosActivos') || '[]');
                const nuevosComerciosCompletos = todosLosComercios.filter(c => c.id !== comercioId);
                localStorage.setItem('comerciosActivos', JSON.stringify(nuevosComerciosCompletos));
                
                renderizarComerciosCarrusel();
                mostrarNotificacion(`‚ùå Comercio ${nombreComercio} eliminado`, 'info');
            }
        }

        function renderizarComerciosCarrusel() {
            const track = document.getElementById('carouselTrack');
            console.log('Renderizando carrusel, track encontrado:', !!track);
            console.log('Comercios activos a renderizar:', comerciosActivos.length, comerciosActivos);
            
            if (!track) {
                console.warn('No se encontr√≥ el elemento carouselTrack');
                return;
            }

            if (comerciosActivos.length === 0) {
                console.log('No hay comercios activos');
                track.innerHTML = '<div style="padding: var(--spacing-xl); text-align: center; color: var(--color-text-secondary);">No hay comercios activos en este momento</div>';
                return;
            }

            track.innerHTML = comerciosActivos.map(comercio => `
                <div class="comercio-card" onclick="verDetalleComercio(${comercio.id})">
                    <div class="comercio-card-header">
                        <div class="comercio-avatar">${comercio.emoji}</div>
                        <div class="comercio-info">
                            <h3>${comercio.nombre}</h3>
                            <div class="comercio-categoria">üìç ${comercio.categoria} ‚Ä¢ ${comercio.distancia} km</div>
                        </div>
                    </div>
                    <div class="comercio-badge">
                        <span style="color: #10b981;">‚óè</span> Activo ahora
                    </div>
                    <div class="comercio-stats">
                        <div class="comercio-stat">
                            <div class="comercio-stat-value">‚≠ê ${comercio.rating}</div>
                            <div class="comercio-stat-label">Rating</div>
                        </div>
                        <div class="comercio-stat">
                            <div class="comercio-stat-value">${comercio.pedidosHoy}</div>
                            <div class="comercio-stat-label">Pedidos hoy</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function moverCarrusel(direccion) {
            const track = document.getElementById('carouselTrack');
            if (!track) return;

            const cardWidth = 280 + 24; // ancho de card + gap
            const visibleCards = Math.floor(track.parentElement.offsetWidth / cardWidth);
            const maxPosition = Math.max(0, comerciosActivos.length - visibleCards);

            carruselPosicion += direccion;
            carruselPosicion = Math.max(0, Math.min(carruselPosicion, maxPosition));

            track.style.transform = `translateX(-${carruselPosicion * cardWidth}px)`;
        }

        function abrirModalComercios() {
            const modal = document.getElementById('modalComercios');
            const modalBody = document.getElementById('modalComerciosBody');
            
            modalBody.innerHTML = `
                <div class="comercios-grid">
                    ${comerciosActivos.map(comercio => `
                        <div class="comercio-card" onclick="verDetalleComercio(${comercio.id})">
                            <div class="comercio-card-header">
                                <div class="comercio-avatar">${comercio.emoji}</div>
                                <div class="comercio-info">
                                    <h3>${comercio.nombre}</h3>
                                    <div class="comercio-categoria">üìç ${comercio.categoria} ‚Ä¢ ${comercio.distancia} km</div>
                                </div>
                            </div>
                            <div class="comercio-badge">
                                <span style="color: #10b981;">‚óè</span> Activo ahora
                            </div>
                            <div class="comercio-stats">
                                <div class="comercio-stat">
                                    <div class="comercio-stat-value">‚≠ê ${comercio.rating}</div>
                                    <div class="comercio-stat-label">Rating</div>
                                </div>
                                <div class="comercio-stat">
                                    <div class="comercio-stat-value">${comercio.pedidosHoy}</div>
                                    <div class="comercio-stat-label">Pedidos hoy</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function cerrarModalComercios(event) {
            const modal = document.getElementById('modalComercios');
            if (!event || event.target === modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        }

        function verDetalleComercio(comercioId) {
            const comercio = comerciosActivos.find(c => c.id === comercioId);
            if (comercio) {
                mostrarNotificacion(`üìç ${comercio.nombre} - ${comercio.categoria} (${comercio.distancia} km)`, 'info');
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            verificarSesion();
            cargarPedidos();
            iniciarTracking();
            
            // Recargar comercios del localStorage antes de renderizar
            comerciosActivos = cargarComerciosActivos();
            renderizarComerciosCarrusel();
            
            // Actualizar cada 30 segundos
            setInterval(cargarPedidos, 30000);
            
            // Actualizar comercios cada 10 segundos
            setInterval(() => {
                comerciosActivos = cargarComerciosActivos();
                renderizarComerciosCarrusel();
            }, 10000);
        });
    </script>
</body>

</html>