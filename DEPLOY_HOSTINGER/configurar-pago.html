<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configurar M√©todo de Pago - YAvoy</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .config-container {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
    }

    .config-header {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    }

    .config-header h1 {
      margin: 0 0 10px 0;
      font-size: 32px;
    }

    .config-header p {
      opacity: 0.9;
      margin: 0;
    }

    .stepper {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
    }

    .stepper::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 10%;
      right: 10%;
      height: 2px;
      background: #e2e8f0;
      z-index: -1;
    }

    .step {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e2e8f0;
      color: #94a3b8;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .step.active .step-number {
      background: #10b981;
      color: white;
      transform: scale(1.2);
    }

    .step.completed .step-number {
      background: #059669;
      color: white;
    }

    .step.completed .step-number::before {
      content: '‚úì';
    }

    .step-label {
      font-size: 14px;
      color: #64748b;
      font-weight: 500;
    }

    .step.active .step-label {
      color: #10b981;
      font-weight: 600;
    }

    .form-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .form-section {
      display: none;
    }

    .form-section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-title {
      font-size: 24px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 10px;
    }

    .form-description {
      color: #64748b;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #1e293b;
      font-size: 14px;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 15px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .form-group.error input {
      border-color: #ef4444;
    }

    .error-message {
      color: #ef4444;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }

    .form-group.error .error-message {
      display: block;
    }

    .input-hint {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 5px;
    }

    .verification-code {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 30px 0;
    }

    .verification-code input {
      width: 50px;
      height: 60px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
    }

    .verification-code input:focus {
      border-color: #10b981;
    }

    .camera-container {
      background: #1e293b;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      margin: 20px 0;
    }

    .camera-preview {
      width: 100%;
      max-width: 400px;
      height: 300px;
      background: #0f172a;
      border-radius: 10px;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      overflow: hidden;
    }

    .camera-preview video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
    }

    .upload-area {
      border: 2px dashed #e2e8f0;
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f8fafc;
    }

    .upload-area:hover {
      border-color: #10b981;
      background: #f0fdf4;
    }

    .upload-area.has-file {
      border-color: #10b981;
      background: #f0fdf4;
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .preview-images {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
    }

    .preview-box {
      flex: 1;
      max-width: 250px;
    }

    .preview-box img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #e2e8f0;
    }

    .preview-label {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
      color: #64748b;
      font-weight: 600;
    }

    .btn-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    .btn {
      flex: 1;
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-secondary {
      background: #f1f5f9;
      color: #64748b;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .btn-primary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .success-message {
      background: #f0fdf4;
      border: 2px solid #10b981;
      border-radius: 16px;
      padding: 30px;
      text-align: center;
      display: none;
    }

    .success-message.show {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    .success-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alert-info {
      background: #dbeafe;
      border: 1px solid #3b82f6;
      color: #1e40af;
    }

    .alert-warning {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      color: #92400e;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-overlay.show {
      display: flex;
    }

    .loading-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
    }

    .spinner {
      border: 4px solid #f1f5f9;
      border-top: 4px solid #10b981;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="config-container">
    <a href="panel-repartidor.html" class="btn-volver">‚Üê Volver al Panel</a>

    <div class="config-header">
      <h1>üîê Configurar M√©todo de Pago</h1>
      <p>Completa tu verificaci√≥n para recibir pagos</p>
    </div>

    <!-- Stepper -->
    <div class="stepper">
      <div class="step active" data-step="1">
        <div class="step-number">1</div>
        <div class="step-label">Datos Bancarios</div>
      </div>
      <div class="step" data-step="2">
        <div class="step-number">2</div>
        <div class="step-label">Verificar Email</div>
      </div>
      <div class="step" data-step="3">
        <div class="step-number">3</div>
        <div class="step-label">Verificar Identidad</div>
      </div>
    </div>

    <!-- Formulario -->
    <div class="form-card">
      <!-- PASO 1: Datos Bancarios -->
      <div class="form-section active" data-section="1">
        <h2 class="form-title">üí≥ Datos Bancarios</h2>
        <p class="form-description">Ingresa tu CBU/CVU donde recibir√°s los pagos</p>

        <div class="alert alert-info">
          <span>‚ÑπÔ∏è</span>
          <span>Los pagos se transferir√°n autom√°ticamente a esta cuenta despu√©s de cada viaje</span>
        </div>

        <div class="form-group">
          <label for="cbu">CBU/CVU *</label>
          <input 
            type="text" 
            id="cbu" 
            maxlength="22" 
            placeholder="0000000000000000000000"
            required
          >
          <div class="input-hint">22 d√≠gitos - Lo encuentras en tu app bancaria</div>
          <div class="error-message">El CBU/CVU debe tener 22 d√≠gitos</div>
        </div>

        <div class="form-group">
          <label for="alias">Alias Bancario (opcional)</label>
          <input 
            type="text" 
            id="alias" 
            placeholder="TU.ALIAS.MP"
          >
          <div class="input-hint">Ejemplo: JUAN.PEREZ.MP</div>
        </div>

        <div class="form-group">
          <label for="banco">Banco</label>
          <select id="banco" required>
            <option value="">Selecciona tu banco</option>
            <option value="macro">Banco Macro</option>
            <option value="galicia">Banco Galicia</option>
            <option value="santander">Banco Santander</option>
            <option value="bbva">BBVA Argentina</option>
            <option value="icbc">ICBC</option>
            <option value="nacion">Banco Naci√≥n</option>
            <option value="provincia">Banco Provincia</option>
            <option value="ciudad">Banco Ciudad</option>
            <option value="supervielle">Supervielle</option>
            <option value="hsbc">HSBC</option>
            <option value="brubank">Brubank</option>
            <option value="naranja">Naranja X</option>
            <option value="mercadopago">Mercado Pago</option>
            <option value="uala">Ual√°</option>
            <option value="otro">Otro</option>
          </select>
        </div>

        <div class="form-group">
          <label for="titular">Titular de la Cuenta *</label>
          <input 
            type="text" 
            id="titular" 
            placeholder="Nombre completo del titular"
            required
          >
          <div class="input-hint">Debe coincidir con tu DNI</div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="window.location.href='panel-repartidor.html'">Cancelar</button>
          <button class="btn btn-primary" onclick="siguientePaso(1)">Continuar ‚Üí</button>
        </div>
      </div>

      <!-- PASO 2: Verificaci√≥n de Email -->
      <div class="form-section" data-section="2">
        <h2 class="form-title">üìß Verificaci√≥n de Email</h2>
        <p class="form-description">Confirma tu email para recibir notificaciones</p>

        <div class="alert alert-warning">
          <span>‚ö†Ô∏è</span>
          <span>Recibir√°s un c√≥digo de 6 d√≠gitos. No compartas este c√≥digo con nadie.</span>
        </div>

        <div class="form-group">
          <label for="email">Email *</label>
          <input 
            type="email" 
            id="email" 
            placeholder="tu@email.com"
            required
          >
          <div class="input-hint">Te enviaremos un c√≥digo de verificaci√≥n</div>
        </div>

        <button class="btn btn-primary w-full mb-xl" onclick="enviarCodigoEmail()">
          Enviar C√≥digo de Verificaci√≥n
        </button>

        <div id="codigoSection" class="d-none">
          <p class="text-center text-secondary mb-lg">
            Ingresa el c√≥digo de 6 d√≠gitos que enviamos a <strong id="emailMostrado"></strong>
          </p>

          <div class="verification-code">
            <input type="text" maxlength="1" id="code1" oninput="moverSiguiente(this, 'code2')">
            <input type="text" maxlength="1" id="code2" oninput="moverSiguiente(this, 'code3')">
            <input type="text" maxlength="1" id="code3" oninput="moverSiguiente(this, 'code4')">
            <input type="text" maxlength="1" id="code4" oninput="moverSiguiente(this, 'code5')">
            <input type="text" maxlength="1" id="code5" oninput="moverSiguiente(this, 'code6')">
            <input type="text" maxlength="1" id="code6" oninput="verificarCodigo()">
          </div>

          <p class="text-center text-secondary text-sm">
            ¬øNo recibiste el c√≥digo? 
            <a href="javascript:enviarCodigoEmail()" class="text-success font-semibold">Reenviar</a>
          </p>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="anteriorPaso(2)">‚Üê Atr√°s</button>
          <button class="btn btn-primary" id="btnContinuarEmail" disabled onclick="siguientePaso(2)">Continuar ‚Üí</button>
        </div>
      </div>

      <!-- PASO 3: Verificaci√≥n de Identidad -->
      <div class="form-section" data-section="3">
        <h2 class="form-title">üë§ Verificaci√≥n de Identidad</h2>
        <p class="form-description">Sube tu DNI y toma una selfie para verificar tu identidad</p>

        <div class="alert alert-info">
          <span>‚ÑπÔ∏è</span>
          <span>Necesitamos verificar que eres t√∫ para garantizar la seguridad de los pagos</span>
        </div>

        <!-- Subir DNI -->
        <div class="mb-2xl">
          <h3 class="mb-md text-primary">üìÑ Foto de tu DNI (frente)</h3>
          <div class="upload-area" id="uploadDNI" onclick="document.getElementById('inputDNI').click()">
            <div class="upload-icon">üì∑</div>
            <p class="m-0 font-semibold text-primary">Haz clic para subir tu DNI</p>
            <p class="mt-xs text-sm text-secondary">JPG, PNG - M√°x 5MB</p>
          </div>
          <input type="file" id="inputDNI" accept="image/*" class="d-none" onchange="previewDNI(event)">
        </div>

        <!-- Capturar Selfie -->
        <div>
          <h3 class="mb-md text-primary">ü§≥ Toma una selfie</h3>
          <div class="camera-container">
            <div class="camera-preview" id="cameraPreview">
              <video id="video" autoplay class="d-none"></video>
              <canvas id="canvas" class="d-none"></canvas>
              <div id="cameraPlaceholder">
                <p class="text-secondary">üìπ Haz clic en "Activar C√°mara"</p>
              </div>
            </div>
            <button class="btn btn-primary w-full max-w-sm" id="btnCamera" onclick="activarCamara()">
              üì∑ Activar C√°mara
            </button>
          </div>
        </div>

        <!-- Preview de ambas im√°genes -->
        <div class="preview-images d-none" id="previewComparacion">
          <div class="preview-box">
            <img id="previewDNIImg" src="" alt="DNI">
            <div class="preview-label">Tu DNI</div>
          </div>
          <div class="preview-box">
            <img id="previewSelfieImg" src="" alt="Selfie">
            <div class="preview-label">Tu Selfie</div>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="anteriorPaso(3)">‚Üê Atr√°s</button>
          <button class="btn btn-primary" id="btnFinalizar" disabled onclick="finalizarConfiguracion()">
            ‚úÖ Finalizar Verificaci√≥n
          </button>
        </div>
      </div>

      <!-- Mensaje de √âxito -->
      <div class="success-message" id="successMessage">
        <div class="success-icon">üéâ</div>
        <h2 class="text-success mb-sm">¬°Verificaci√≥n Completada!</h2>
        <p class="text-secondary mb-xl">
          Tu cuenta ha sido verificada exitosamente. Ya puedes recibir pagos.
        </p>
        <button class="btn btn-primary" onclick="window.location.href='panel-repartidor.html'">
          Ir al Panel
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p class="text-primary font-semibold">Verificando...</p>
      <p class="text-secondary text-sm">Por favor espera</p>
    </div>
  </div>

  <script>
    let currentStep = 1;
    let formData = {
      cbu: '',
      alias: '',
      banco: '',
      titular: '',
      email: '',
      emailVerificado: false,
      dniImagen: null,
      selfieImagen: null,
      identidadVerificada: false
    };
    let codigoVerificacion = null;
    let videoStream = null;

    // Navegaci√≥n entre pasos
    function siguientePaso(paso) {
      if (validarPaso(paso)) {
        currentStep++;
        actualizarVista();
      }
    }

    function anteriorPaso(paso) {
      currentStep--;
      actualizarVista();
    }

    function actualizarVista() {
      // Actualizar stepper
      document.querySelectorAll('.step').forEach((step, index) => {
        const stepNum = index + 1;
        step.classList.remove('active', 'completed');
        if (stepNum === currentStep) {
          step.classList.add('active');
        } else if (stepNum < currentStep) {
          step.classList.add('completed');
        }
      });

      // Actualizar secciones
      document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
      });
      document.querySelector(`[data-section="${currentStep}"]`).classList.add('active');
    }

    // Validaciones
    function validarPaso(paso) {
      if (paso === 1) {
        const cbu = document.getElementById('cbu').value;
        const titular = document.getElementById('titular').value;
        const banco = document.getElementById('banco').value;

        if (!cbu || cbu.length !== 22) {
          alert('‚ö†Ô∏è El CBU/CVU debe tener 22 d√≠gitos');
          return false;
        }

        if (!titular) {
          alert('‚ö†Ô∏è Ingresa el nombre del titular');
          return false;
        }

        if (!banco) {
          alert('‚ö†Ô∏è Selecciona tu banco');
          return false;
        }

        formData.cbu = cbu;
        formData.alias = document.getElementById('alias').value;
        formData.banco = banco;
        formData.titular = titular;
        return true;
      }

      if (paso === 2) {
        if (!formData.emailVerificado) {
          alert('‚ö†Ô∏è Debes verificar tu email primero');
          return false;
        }
        return true;
      }

      return true;
    }

    // Verificaci√≥n de Email
    async function enviarCodigoEmail() {
      const email = document.getElementById('email').value;
      
      if (!email || !email.includes('@')) {
        alert('‚ö†Ô∏è Ingresa un email v√°lido');
        return;
      }

      mostrarLoading(true);

      try {
        // Generar c√≥digo aleatorio
        codigoVerificacion = Math.floor(100000 + Math.random() * 900000).toString();
        
        // Enviar c√≥digo al backend
        const response = await fetch('http://localhost:5501/api/enviar-codigo-verificacion', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, codigo: codigoVerificacion })
        });

        if (response.ok) {
          document.getElementById('emailMostrado').textContent = email;
          document.getElementById('codigoSection').style.display = 'block';
          document.getElementById('code1').focus();
          alert('‚úÖ C√≥digo enviado a ' + email);
        }
      } catch (error) {
        alert('‚ùå Error al enviar c√≥digo: ' + error.message);
      } finally {
        mostrarLoading(false);
      }
    }

    function moverSiguiente(input, siguienteId) {
      if (input.value.length === 1) {
        const siguiente = document.getElementById(siguienteId);
        if (siguiente) siguiente.focus();
      }
    }

    function verificarCodigo() {
      const codigo = Array.from({length: 6}, (_, i) => 
        document.getElementById(`code${i+1}`).value
      ).join('');

      if (codigo.length === 6) {
        if (codigo === codigoVerificacion) {
          formData.email = document.getElementById('email').value;
          formData.emailVerificado = true;
          document.getElementById('btnContinuarEmail').disabled = false;
          alert('‚úÖ Email verificado correctamente');
        } else {
          alert('‚ùå C√≥digo incorrecto. Intenta nuevamente.');
          document.querySelectorAll('.verification-code input').forEach(input => input.value = '');
          document.getElementById('code1').focus();
        }
      }
    }

    // Verificaci√≥n de Identidad
    function previewDNI(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          formData.dniImagen = e.target.result;
          document.getElementById('uploadDNI').classList.add('has-file');
          document.getElementById('uploadDNI').innerHTML = `
            <div class="upload-icon">‚úÖ</div>
            <p style="margin: 0; font-weight: 600; color: #10b981;">DNI Cargado</p>
            <p style="margin: 5px 0 0 0; font-size: 14px; color: #64748b;">Haz clic para cambiar</p>
          `;
          document.getElementById('previewDNIImg').src = e.target.result;
          verificarCompletitud();
        };
        reader.readAsDataURL(file);
      }
    }

    async function activarCamara() {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'user' } 
        });
        
        const video = document.getElementById('video');
        video.srcObject = videoStream;
        video.style.display = 'block';
        document.getElementById('cameraPlaceholder').style.display = 'none';
        
        document.getElementById('btnCamera').textContent = 'üì∏ Capturar Selfie';
        document.getElementById('btnCamera').onclick = capturarSelfie;
      } catch (error) {
        alert('‚ùå Error al acceder a la c√°mara: ' + error.message);
      }
    }

    function capturarSelfie() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const context = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0);
      
      formData.selfieImagen = canvas.toDataURL('image/jpeg');
      document.getElementById('previewSelfieImg').src = formData.selfieImagen;
      document.getElementById('previewComparacion').style.display = 'flex';
      
      // Detener c√°mara
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
      }
      
      video.style.display = 'none';
      document.getElementById('cameraPlaceholder').style.display = 'block';
      document.getElementById('cameraPlaceholder').innerHTML = '<p style="color: #10b981;">‚úÖ Selfie capturada</p>';
      document.getElementById('btnCamera').textContent = 'üîÑ Tomar otra foto';
      document.getElementById('btnCamera').onclick = activarCamara;
      
      verificarCompletitud();
    }

    function verificarCompletitud() {
      if (formData.dniImagen && formData.selfieImagen) {
        document.getElementById('btnFinalizar').disabled = false;
      }
    }

    // Finalizar configuraci√≥n
    async function finalizarConfiguracion() {
      mostrarLoading(true);

      try {
        const repartidorData = JSON.parse(sessionStorage.getItem('repartidorActual') || '{}');
        const repartidorId = repartidorData.id || 'REP-01';

        const response = await fetch(`http://localhost:5501/api/repartidores/${repartidorId}/configurar-pago`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            metodoPago: 'mercadopago',
            cbu: formData.cbu,
            alias: formData.alias,
            banco: formData.banco,
            titular: formData.titular,
            email: formData.email,
            emailVerificado: formData.emailVerificado,
            dniImagen: formData.dniImagen,
            selfieImagen: formData.selfieImagen,
            identidadVerificada: true
          })
        });

        const data = await response.json();

        if (data.success) {
          // Mostrar mensaje de √©xito
          document.querySelector('.form-section.active').style.display = 'none';
          document.getElementById('successMessage').classList.add('show');
        } else {
          throw new Error(data.error || 'Error al configurar pago');
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      } finally {
        mostrarLoading(false);
      }
    }

    function mostrarLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('show', show);
    }

    // Validaci√≥n en tiempo real del CBU
    document.getElementById('cbu').addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 22);
    });
  </script>
</body>
</html>
