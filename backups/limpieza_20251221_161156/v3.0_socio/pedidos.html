<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YaVoy - Gesti√≥n de Pedidos</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
            --bg-primary: #0f1724;
            --bg-secondary: #1a2332;
            --bg-card: #243241;
            --text-primary: #e6eef6;
            --text-secondary: #ffffff;
            --border-color: #3a4a5c;
            --color-primario: #06b6d4;
        }

        body {
            background: linear-gradient(180deg, var(--bg-primary), #071021);
            color: var(--text-primary);
            margin: 0;
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
        }

        .navbar {
            background: var(--bg-secondary);
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-container h1 {
            color: var(--text-secondary);
            margin: 0;
        }

        .pedidos-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-primary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: var(--color-primario);
        }

        .tab.active {
            color: var(--color-primario);
            border-bottom-color: var(--color-primario);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h2,
        .tab-content h3 {
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #8899aa;
        }

        .form-group select {
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .form-group select option {
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .productos-list {
            margin-bottom: 15px;
        }

        .producto-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 5px;
        }

        .producto-item input {
            flex: 1;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .pedidos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pedido-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            background: var(--bg-card);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .pedido-id {
            font-weight: bold;
            color: var(--text-secondary);
        }

        .badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-pendiente {
            background: #ffc107;
            color: #000;
        }

        .badge-asignado {
            background: #17a2b8;
            color: white;
        }

        .badge-en-camino {
            background: #007bff;
            color: white;
        }

        .badge-entregado {
            background: #28a745;
            color: white;
        }

        .badge-cancelado {
            background: #dc3545;
            color: white;
        }

        .pedido-info p {
            margin: 5px 0;
            font-size: 14px;
            color: var(--text-primary);
        }

        .pedido-info p strong {
            color: var(--text-secondary);
        }

        .pedido-productos {
            margin: 10px 0;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 5px;
        }

        .pedido-productos strong {
            color: var(--text-secondary);
        }

        .pedido-productos ul {
            margin: 5px 0;
            padding-left: 20px;
            color: var(--text-primary);
        }

        .pedido-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .chat-container {
            margin-top: 15px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .chat-messages {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 5px;
        }

        .mensaje {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
        }

        .mensaje-cliente {
            background: #1e3a5f;
            text-align: left;
        }

        .mensaje-repartidor {
            background: #3d3416;
            text-align: right;
        }

        .mensaje-remitente {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 3px;
            color: var(--text-secondary);
        }

        .mensaje-texto {
            font-size: 14px;
            color: var(--text-primary);
        }

        .mensaje-tiempo {
            font-size: 11px;
            color: #8899aa;
            margin-top: 3px;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
        }

        .chat-input select {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 5px;
            min-width: 120px;
        }

        .chat-input select option {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .filtros {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 5px;
        }

        .filtro-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filtro-item label {
            font-size: 12px;
            font-weight: bold;
            color: var(--text-secondary);
        }

        .filtro-item select {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
        }

        .filtro-item select option {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            padding: 15px;
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: var(--color-primario);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-primary);
            margin-top: 5px;
        }

        .repartidor-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: var(--bg-card);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .repartidor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .repartidor-header strong {
            color: var(--text-secondary);
        }

        .repartidor-header small {
            color: var(--text-primary);
        }

        .repartidor-card p {
            color: var(--text-primary);
        }

        .repartidor-card p strong {
            color: var(--text-secondary);
        }

        .disponible-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .disponible-si {
            background: #28a745;
            color: white;
        }

        .disponible-no {
            background: #dc3545;
            color: white;
        }

        /* Modo d√≠a */
        @media (prefers-color-scheme: light) {
            :root {
                --bg-primary: #f5f7fa;
                --bg-secondary: #ffffff;
                --bg-card: #ffffff;
                --text-primary: #2c3e50;
                --text-secondary: #1a252f;
                --border-color: #dee2e6;
                --color-primario: #0056b3;
            }

            body {
                background: linear-gradient(180deg, #f5f7fa, #e9ecef);
            }

            .navbar {
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }

            .pedido-card,
            .stat-card,
            .repartidor-card {
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }

            .form-group input::placeholder,
            .form-group textarea::placeholder {
                color: #6c757d;
            }

            .mensaje-cliente {
                background: #e3f2fd;
            }

            .mensaje-repartidor {
                background: #fff3cd;
            }

            .mensaje-tiempo {
                color: #6c757d;
            }

            .chat-messages {
                background: #f8f9fa;
            }

            .pedido-productos {
                background: #f8f9fa;
            }

            .producto-item {
                background: #f8f9fa;
            }

            .filtros {
                background: #f8f9fa;
            }
        }

        /* Estilos del Carrusel de Comercios */
        .comercios-carousel-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .comercios-carousel {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding: 15px 5px;
            scrollbar-width: thin;
            scrollbar-color: #06b6d4 var(--bg-secondary);
            flex: 1;
        }

        .comercios-carousel::-webkit-scrollbar {
            height: 8px;
        }

        .comercios-carousel::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .comercios-carousel::-webkit-scrollbar-thumb {
            background: #06b6d4;
            border-radius: 4px;
        }

        .comercios-carousel::-webkit-scrollbar-thumb:hover {
            background: #0891b2;
        }

        .comercio-card {
            min-width: 200px;
            max-width: 200px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .comercio-card:hover {
            transform: translateY(-5px);
            border-color: #06b6d4;
            box-shadow: 0 8px 20px rgba(6, 182, 212, 0.3);
        }

        .comercio-card.selected {
            border-color: #06b6d4;
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
            background: linear-gradient(135deg, var(--bg-secondary), rgba(6, 182, 212, 0.1));
        }

        .comercio-card-header {
            height: 80px;
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            position: relative;
        }

        .comercio-card.selected .comercio-card-header::after {
            content: '‚úì';
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
        }

        .comercio-card-body {
            padding: 12px;
        }

        .comercio-card-nombre {
            font-weight: bold;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .comercio-card-categoria {
            font-size: 11px;
            color: #06b6d4;
            background: rgba(6, 182, 212, 0.15);
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 8px;
        }

        .comercio-card-info {
            font-size: 11px;
            color: #94a3b8;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .comercio-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .comercio-btn {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .comercio-btn-select {
            background: #06b6d4;
            color: white;
        }

        .comercio-btn-select:hover {
            background: #0891b2;
            transform: scale(1.05);
        }

        .comercio-btn-visit {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .comercio-btn-visit:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #06b6d4;
        }

        .carousel-btn {
            width: 40px;
            height: 40px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            color: #06b6d4;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .carousel-btn:hover {
            background: #06b6d4;
            color: white;
            transform: scale(1.1);
        }

        .carousel-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .carousel-btn:disabled:hover {
            background: var(--bg-secondary);
            color: #06b6d4;
            transform: scale(1);
        }

        @media (max-width: 768px) {
            .comercio-card {
                min-width: 160px;
                max-width: 160px;
            }

            .carousel-btn {
                display: none;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1>üöÄ YaVoy - Gesti√≥n de Pedidos</h1>
            <a href="index.html" class="btn btn-secondary">‚Üê Volver</a>
        </div>
    </nav>

    <div class="pedidos-container">
        <div class="tabs">
            <button class="tab active" data-tab="crear">Crear Pedido</button>
            <button class="tab" data-tab="lista">Lista de Pedidos Disponibles</button>
            <button class="tab" data-tab="pendientes">Pedidos Pendientes</button>
            <button class="tab" data-tab="repartidores">Repartidores</button>
        </div>

        <!-- TAB: CREAR PEDIDO -->
        <div id="crear" class="tab-content active">
            <h2>Crear Nuevo Pedido</h2>
            <form id="formCrearPedido">
                <div class="form-group">
                    <label>Nombre del Cliente *</label>
                    <input type="text" id="clienteNombre" required>
                </div>

                <div class="form-group">
                    <label>Tel√©fono del Cliente</label>
                    <input type="tel" id="clienteTelefono">
                </div>

                <div class="form-group">
                    <label>Direcci√≥n de Entrega *</label>
                    <textarea id="direccion" rows="3" required></textarea>
                </div>

                <!-- Carrusel de Comercios Disponibles -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <span style="font-size: 18px;">üè™ Comercios Disponibles</span>
                        <span style="font-size: 12px; color: #94a3b8; font-weight: normal;">(Selecciona uno o visita su tienda)</span>
                    </label>
                    
                    <div class="comercios-carousel-wrapper">
                        <button class="carousel-btn carousel-prev" onclick="scrollCarousel('prev')" aria-label="Anterior">
                            ‚Äπ
                        </button>
                        
                        <div class="comercios-carousel" id="comerciosCarousel">
                            <!-- Los comercios se cargar√°n din√°micamente aqu√≠ -->
                            <div class="comercio-loading" style="text-align: center; padding: 40px; color: #94a3b8;">
                                Cargando comercios...
                            </div>
                        </div>
                        
                        <button class="carousel-btn carousel-next" onclick="scrollCarousel('next')" aria-label="Siguiente">
                            ‚Ä∫
                        </button>
                    </div>
                    
                    <div style="margin-top: 10px; padding: 10px; background: rgba(6, 182, 212, 0.1); border-left: 3px solid #06b6d4; border-radius: 4px;">
                        <p style="margin: 0; font-size: 13px; color: #94a3b8;">
                            üí° <strong style="color: #ffffff;">Comercio seleccionado:</strong> 
                            <span id="comercioSeleccionadoNombre" style="color: #06b6d4;">Ninguno</span>
                        </p>
                    </div>
                </div>

                <div class="form-group" style="display: none;">
                    <label>Comercio</label>
                    <select id="comercioId">
                        <option value="">Seleccionar comercio (opcional)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Productos</label>
                    <div class="productos-list" id="productosList">
                        <div class="producto-item">
                            <input type="text" placeholder="Nombre del producto" class="producto-nombre">
                            <input type="number" placeholder="Cantidad" class="producto-cantidad" min="1" value="1">
                            <input type="number" placeholder="Precio" class="producto-precio" step="0.01" min="0">
                            <button type="button" class="btn btn-danger" onclick="eliminarProducto(this)">-</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="agregarProducto()">+ Agregar Producto</button>
                </div>

                <div class="form-group">
                    <label>Total $</label>
                    <input type="number" id="total" step="0.01" min="0" required>
                </div>

                <button type="submit" class="btn btn-primary">Crear Pedido</button>
            </form>
        </div>

        <!-- TAB: LISTA DE PEDIDOS DISPONIBLES -->
        <div id="lista" class="tab-content">
            <h2>Pedidos Disponibles para Asignar</h2>
            <p style="color: var(--text-primary); margin-bottom: 20px;">Estos son los pedidos que a√∫n no han sido tomados por ning√∫n repartidor.</p>
            
            <div class="pedidos-grid" id="pedidosDisponiblesGrid"></div>
        </div>

        <!-- TAB: PEDIDOS PENDIENTES (ASIGNADOS) -->
        <div id="pendientes" class="tab-content">
            <h2>Pedidos Pendientes de Entrega</h2>
            <p style="color: var(--text-primary); margin-bottom: 20px;">Pedidos que ya fueron asignados a repartidores y est√°n en proceso.</p>
            
            <div class="stats" id="statsPendientesContainer"></div>

            <div class="filtros">
                <div class="filtro-item">
                    <label>Estado</label>
                    <select id="filtroPendientesEstado">
                        <option value="">Todos</option>
                        <option value="asignado">Asignados</option>
                        <option value="en-camino">En Camino</option>
                        <option value="entregado">Entregados</option>
                    </select>
                </div>
                <div class="filtro-item">
                    <label>Repartidor</label>
                    <select id="filtroPendientesRepartidor">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filtro-item">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="cargarPedidosPendientes()">Filtrar</button>
                </div>
            </div>

            <div class="pedidos-grid" id="pedidosPendientesGrid"></div>
        </div>

        <!-- TAB: REPARTIDORES -->
        <div id="repartidores" class="tab-content">
            <h2>Gesti√≥n de Repartidores</h2>
            
            <form id="formRegistrarRepartidor" style="max-width: 600px; margin-bottom: 30px;">
                <h3>Registrar Nuevo Repartidor</h3>
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" id="repNombre" required>
                </div>
                <div class="form-group">
                    <label>Tel√©fono *</label>
                    <input type="tel" id="repTelefono" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="repEmail">
                </div>
                <div class="form-group">
                    <label>Veh√≠culo</label>
                    <select id="repVehiculo">
                        <option value="moto">Moto</option>
                        <option value="bicicleta">Bicicleta</option>
                        <option value="auto">Auto</option>
                        <option value="a-pie">A pie</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Registrar Repartidor</button>
            </form>

            <h3>Lista de Repartidores</h3>
            <div id="repartidoresList"></div>
        </div>
    </div>

    <script>
        // Sistema de tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                
                // Desactivar todos los tabs y contenidos
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Activar tab y contenido seleccionado
                tab.classList.add('active');
                document.getElementById(tabId).classList.add('active');

                // Cargar datos seg√∫n el tab
                if (tabId === 'lista') {
                    cargarPedidosDisponibles();
                } else if (tabId === 'pendientes') {
                    cargarPedidosPendientes();
                    cargarRepartidoresParaFiltroPendientes();
                } else if (tabId === 'repartidores') {
                    cargarRepartidores();
                }
            });
        });

        // Gesti√≥n de productos en el formulario
        function agregarProducto() {
            const productoHTML = `
                <div class="producto-item">
                    <input type="text" placeholder="Nombre del producto" class="producto-nombre">
                    <input type="number" placeholder="Cantidad" class="producto-cantidad" min="1" value="1">
                    <input type="number" placeholder="Precio" class="producto-precio" step="0.01" min="0">
                    <button type="button" class="btn btn-danger" onclick="eliminarProducto(this)">-</button>
                </div>
            `;
            document.getElementById('productosList').insertAdjacentHTML('beforeend', productoHTML);
        }

        function eliminarProducto(btn) {
            if (document.querySelectorAll('.producto-item').length > 1) {
                btn.closest('.producto-item').remove();
            } else {
                alert('Debe haber al menos un producto');
            }
        }

        // Crear pedido
        document.getElementById('formCrearPedido').addEventListener('submit', async (e) => {
            e.preventDefault();

            const productos = [];
            document.querySelectorAll('.producto-item').forEach(item => {
                const nombre = item.querySelector('.producto-nombre').value;
                const cantidad = parseInt(item.querySelector('.producto-cantidad').value);
                const precio = parseFloat(item.querySelector('.producto-precio').value);
                
                if (nombre && cantidad && precio) {
                    productos.push({ nombre, cantidad, precio });
                }
            });

            if (productos.length === 0) {
                alert('Debe agregar al menos un producto v√°lido');
                return;
            }

            const pedido = {
                clienteNombre: document.getElementById('clienteNombre').value,
                clienteTelefono: document.getElementById('clienteTelefono').value,
                direccion: document.getElementById('direccion').value,
                comercioId: document.getElementById('comercioId').value,
                productos: productos,
                total: parseFloat(document.getElementById('total').value)
            };

            try {
                const response = await fetch('/api/pedidos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pedido)
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úì Pedido creado exitosamente: ' + data.pedido.id);
                    document.getElementById('formCrearPedido').reset();
                    document.getElementById('productosList').innerHTML = `
                        <div class="producto-item">
                            <input type="text" placeholder="Nombre del producto" class="producto-nombre">
                            <input type="number" placeholder="Cantidad" class="producto-cantidad" min="1" value="1">
                            <input type="number" placeholder="Precio" class="producto-precio" step="0.01" min="0">
                            <button type="button" class="btn btn-danger" onclick="eliminarProducto(this)">-</button>
                        </div>
                    `;
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error al crear pedido: ' + error.message);
            }
        });

        // Cargar pedidos
        // Cargar pedidos disponibles (solo estado pendiente)
        async function cargarPedidosDisponibles() {
            try {
                const response = await fetch('/api/pedidos?estado=pendiente');
                const data = await response.json();

                if (data.success) {
                    mostrarPedidosDisponibles(data.pedidos);
                }
            } catch (error) {
                console.error('Error al cargar pedidos disponibles:', error);
            }
        }

        function mostrarPedidosDisponibles(pedidos) {
            const grid = document.getElementById('pedidosDisponiblesGrid');
            
            if (pedidos.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-primary); text-align: center; padding: 40px;">No hay pedidos disponibles en este momento</p>';
                return;
            }

            grid.innerHTML = pedidos.map(pedido => `
                <div class="pedido-card">
                    <div class="pedido-header">
                        <span class="pedido-id">${pedido.id}</span>
                        <span class="badge badge-pendiente">DISPONIBLE</span>
                    </div>
                    <div class="pedido-info">
                        <p><strong>Cliente:</strong> ${pedido.clienteNombre}</p>
                        <p><strong>Direcci√≥n de Entrega:</strong> ${pedido.direccion}</p>
                        <div class="pedido-productos">
                            <strong>Productos:</strong>
                            <ul>
                                ${pedido.productos.map(p => `<li>${p.nombre} x${p.cantidad} - $${p.precio}</li>`).join('')}
                            </ul>
                        </div>
                        <p><strong>Total:</strong> $${pedido.total}</p>
                        <p><strong>Creado:</strong> ${new Date(pedido.createdAt).toLocaleString()}</p>
                    </div>
                    <div class="pedido-actions">
                        <button class="btn btn-success" onclick="tomarPedido('${pedido.id}')" style="width: 100%;">üöÄ Tomar Pedido</button>
                    </div>
                </div>
            `).join('');
        }

        // Tomar pedido (asignar repartidor)
        async function tomarPedido(pedidoId) {
            const repartidorId = prompt('Ingrese su ID de repartidor:');
            if (!repartidorId) return;

            try {
                const response = await fetch(`/api/pedidos/${pedidoId}/asignar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ repartidorId })
                });

                const data = await response.json();
                if (data.success) {
                    alert('‚úì Pedido tomado exitosamente. Ahora aparecer√° en "Pedidos Pendientes"');
                    cargarPedidosDisponibles();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Cargar pedidos pendientes (asignados, en-camino, entregados)
        async function cargarPedidosPendientes() {
            const estado = document.getElementById('filtroPendientesEstado').value;
            const repartidorId = document.getElementById('filtroPendientesRepartidor').value;

            let url = '/api/pedidos?';
            const filtros = [];
            
            // Filtrar estados que NO sean pendiente
            if (estado) {
                filtros.push(`estado=${estado}`);
            } else {
                // Si no se especifica, mostrar asignado, en-camino y entregado
                filtros.push('estado=asignado,en-camino,entregado');
            }
            
            if (repartidorId) {
                filtros.push(`repartidorId=${repartidorId}`);
            }

            url += filtros.join('&');

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    // Filtrar solo pedidos que NO est√©n en pendiente
                    const pedidosPendientes = data.pedidos.filter(p => p.estado !== 'pendiente');
                    mostrarPedidosPendientes(pedidosPendientes);
                    mostrarEstadisticasPendientes(pedidosPendientes);
                }
            } catch (error) {
                console.error('Error al cargar pedidos pendientes:', error);
            }
        }

        function mostrarEstadisticasPendientes(pedidos) {
            const stats = {
                total: pedidos.length,
                asignados: pedidos.filter(p => p.estado === 'asignado').length,
                enCamino: pedidos.filter(p => p.estado === 'en-camino').length,
                entregados: pedidos.filter(p => p.estado === 'entregado').length
            };

            document.getElementById('statsPendientesContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Total Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.asignados}</div>
                    <div class="stat-label">Asignados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.enCamino}</div>
                    <div class="stat-label">En Camino</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.entregados}</div>
                    <div class="stat-label">Entregados</div>
                </div>
            `;
        }

        function mostrarPedidosPendientes(pedidos) {
            const grid = document.getElementById('pedidosPendientesGrid');
            
            if (pedidos.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-primary); text-align: center; padding: 40px;">No hay pedidos pendientes</p>';
                return;
            }

            grid.innerHTML = pedidos.map(pedido => `
                <div class="pedido-card">
                    <div class="pedido-header">
                        <span class="pedido-id">${pedido.id}</span>
                        <span class="badge badge-${pedido.estado}">${pedido.estado.toUpperCase()}</span>
                    </div>
                    <div class="pedido-info">
                        <p><strong>Cliente:</strong> ${pedido.clienteNombre}</p>
                        <p><strong>Tel√©fono:</strong> ${pedido.clienteTelefono || 'No especificado'}</p>
                        <p><strong>Direcci√≥n de Entrega:</strong> ${pedido.direccion}</p>
                        <div class="pedido-productos">
                            <strong>Productos:</strong>
                            <ul>
                                ${pedido.productos.map(p => `<li>${p.nombre} x${p.cantidad} - $${p.precio}</li>`).join('')}
                            </ul>
                        </div>
                        <p><strong>Total:</strong> $${pedido.total}</p>
                        <p><strong>Repartidor:</strong> ${pedido.repartidorId}</p>
                    </div>
                    <div class="pedido-actions">
                        ${pedido.estado === 'asignado' ? `
                            <button class="btn btn-primary" onclick="cambiarEstado('${pedido.id}', 'en-camino')">üö¥ Salir a Entregar</button>
                        ` : ''}
                        ${pedido.estado === 'en-camino' ? `
                            <button class="btn btn-success" onclick="cambiarEstado('${pedido.id}', 'entregado')">‚úì Marcar Entregado</button>
                        ` : ''}
                        ${pedido.estado === 'entregado' ? `
                            <span style="color: #28a745; font-weight: bold;">‚úì Pedido Completado</span>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="toggleChat('${pedido.id}')">üí¨ Chat</button>
                    </div>
                    <div id="chat-${pedido.id}" class="chat-container" style="display: none;">
                        <div class="chat-messages" id="mensajes-${pedido.id}"></div>
                        <div class="chat-input">
                            <input type="text" id="mensaje-${pedido.id}" placeholder="Escribe un mensaje...">
                            <select id="remitente-${pedido.id}">
                                <option value="cliente">Cliente</option>
                                <option value="repartidor">Repartidor</option>
                            </select>
                            <button class="btn btn-primary" onclick="enviarMensaje('${pedido.id}')">Enviar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function cargarRepartidoresParaFiltroPendientes() {
            try {
                const response = await fetch('/api/repartidores');
                const data = await response.json();

                if (data.success) {
                    const select = document.getElementById('filtroPendientesRepartidor');
                    select.innerHTML = '<option value="">Todos</option>' + 
                        data.repartidores.map(rep => 
                            `<option value="${rep.id}">${rep.nombre} (${rep.id})</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error al cargar repartidores:', error);
            }
        }

        // Funci√≥n legacy - mantener para compatibilidad
        async function cargarPedidos() {
            // Redirigir a la nueva funci√≥n
            await cargarPedidosDisponibles();
        }

        function mostrarEstadisticas(pedidos) {
            const stats = {
                total: pedidos.length,
                pendientes: pedidos.filter(p => p.estado === 'pendiente').length,
                enCamino: pedidos.filter(p => p.estado === 'en-camino').length,
                entregados: pedidos.filter(p => p.estado === 'entregado').length
            };

            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Total Pedidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.pendientes}</div>
                    <div class="stat-label">Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.enCamino}</div>
                    <div class="stat-label">En Camino</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.entregados}</div>
                    <div class="stat-label">Entregados</div>
                </div>
            `;
        }

        function mostrarPedidos(pedidos) {
            const grid = document.getElementById('pedidosGrid');
            
            if (pedidos.length === 0) {
                grid.innerHTML = '<p>No hay pedidos para mostrar</p>';
                return;
            }

            grid.innerHTML = pedidos.map(pedido => `
                <div class="pedido-card">
                    <div class="pedido-header">
                        <span class="pedido-id">${pedido.id}</span>
                        <span class="badge badge-${pedido.estado}">${pedido.estado.toUpperCase()}</span>
                    </div>
                    <div class="pedido-info">
                        <p><strong>Cliente:</strong> ${pedido.clienteNombre}</p>
                        <p><strong>Tel√©fono:</strong> ${pedido.clienteTelefono || 'No especificado'}</p>
                        <p><strong>Direcci√≥n:</strong> ${pedido.direccion}</p>
                        <div class="pedido-productos">
                            <strong>Productos:</strong>
                            <ul>
                                ${pedido.productos.map(p => `<li>${p.nombre} x${p.cantidad} - $${p.precio}</li>`).join('')}
                            </ul>
                        </div>
                        <p><strong>Total:</strong> $${pedido.total}</p>
                        ${pedido.repartidorId ? `<p><strong>Repartidor:</strong> ${pedido.repartidorId}</p>` : ''}
                    </div>
                    <div class="pedido-actions">
                        ${pedido.estado === 'pendiente' ? `
                            <button class="btn btn-primary" onclick="asignarRepartidor('${pedido.id}')">Asignar</button>
                        ` : ''}
                        ${pedido.estado === 'asignado' ? `
                            <button class="btn btn-success" onclick="cambiarEstado('${pedido.id}', 'en-camino')">En Camino</button>
                        ` : ''}
                        ${pedido.estado === 'en-camino' ? `
                            <button class="btn btn-success" onclick="cambiarEstado('${pedido.id}', 'entregado')">Entregar</button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="toggleChat('${pedido.id}')">üí¨ Chat</button>
                    </div>
                    <div id="chat-${pedido.id}" class="chat-container" style="display: none;">
                        <div class="chat-messages" id="mensajes-${pedido.id}"></div>
                        <div class="chat-input">
                            <input type="text" id="mensaje-${pedido.id}" placeholder="Escribe un mensaje...">
                            <select id="remitente-${pedido.id}">
                                <option value="cliente">Cliente</option>
                                <option value="repartidor">Repartidor</option>
                            </select>
                            <button class="btn btn-primary" onclick="enviarMensaje('${pedido.id}')">Enviar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function asignarRepartidor(pedidoId) {
            const repartidorId = prompt('Ingrese el ID del repartidor:');
            if (!repartidorId) return;

            try {
                const response = await fetch(`/api/pedidos/${pedidoId}/asignar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ repartidorId })
                });

                const data = await response.json();
                if (data.success) {
                    alert('‚úì Repartidor asignado');
                    cargarPedidos();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function cambiarEstado(pedidoId, nuevoEstado) {
            try {
                const response = await fetch(`/api/pedidos/${pedidoId}/estado`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ estado: nuevoEstado })
                });

                const data = await response.json();
                if (data.success) {
                    alert('‚úì Estado actualizado');
                    // Recargar la lista de pendientes
                    cargarPedidosPendientes();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function toggleChat(pedidoId) {
            const chatDiv = document.getElementById(`chat-${pedidoId}`);
            if (chatDiv.style.display === 'none') {
                chatDiv.style.display = 'block';
                await cargarMensajes(pedidoId);
            } else {
                chatDiv.style.display = 'none';
            }
        }

        async function cargarMensajes(pedidoId) {
            try {
                const response = await fetch(`/api/pedidos/${pedidoId}/chat`);
                const data = await response.json();

                if (data.success) {
                    const mensajesDiv = document.getElementById(`mensajes-${pedidoId}`);
                    mensajesDiv.innerHTML = data.mensajes.map(msg => `
                        <div class="mensaje mensaje-${msg.remitente}">
                            <div class="mensaje-remitente">${msg.remitente}</div>
                            <div class="mensaje-texto">${msg.mensaje}</div>
                            <div class="mensaje-tiempo">${new Date(msg.timestamp).toLocaleString()}</div>
                        </div>
                    `).join('');
                    mensajesDiv.scrollTop = mensajesDiv.scrollHeight;
                }
            } catch (error) {
                console.error('Error al cargar mensajes:', error);
            }
        }

        async function enviarMensaje(pedidoId) {
            const mensaje = document.getElementById(`mensaje-${pedidoId}`).value;
            const remitente = document.getElementById(`remitente-${pedidoId}`).value;

            if (!mensaje.trim()) return;

            try {
                const response = await fetch(`/api/pedidos/${pedidoId}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mensaje, remitente })
                });

                const data = await response.json();
                if (data.success) {
                    document.getElementById(`mensaje-${pedidoId}`).value = '';
                    await cargarMensajes(pedidoId);
                }
            } catch (error) {
                alert('Error al enviar mensaje: ' + error.message);
            }
        }

        // Registrar repartidor
        document.getElementById('formRegistrarRepartidor').addEventListener('submit', async (e) => {
            e.preventDefault();

            const repartidor = {
                nombre: document.getElementById('repNombre').value,
                telefono: document.getElementById('repTelefono').value,
                email: document.getElementById('repEmail').value,
                vehiculo: document.getElementById('repVehiculo').value
            };

            try {
                const response = await fetch('/api/repartidores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(repartidor)
                });

                const data = await response.json();
                if (data.success) {
                    alert('‚úì Repartidor registrado: ' + data.repartidor.id);
                    document.getElementById('formRegistrarRepartidor').reset();
                    cargarRepartidores();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        async function cargarRepartidores() {
            try {
                const response = await fetch('/api/repartidores');
                const data = await response.json();

                if (data.success) {
                    const lista = document.getElementById('repartidoresList');
                    lista.innerHTML = data.repartidores.map(rep => `
                        <div class="repartidor-card">
                            <div class="repartidor-header">
                                <div>
                                    <strong>${rep.nombre}</strong> (${rep.id})
                                    <br>
                                    <small>${rep.telefono} ‚Ä¢ ${rep.vehiculo}</small>
                                </div>
                                <span class="disponible-badge ${rep.disponible ? 'disponible-si' : 'disponible-no'}">
                                    ${rep.disponible ? 'Disponible' : 'Ocupado'}
                                </span>
                            </div>
                            <p><strong>Pedidos activos:</strong> ${rep.pedidosActivos}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error al cargar repartidores:', error);
            }
        }

        async function cargarRepartidoresParaFiltro() {
            try {
                const response = await fetch('/api/repartidores');
                const data = await response.json();

                if (data.success) {
                    const select = document.getElementById('filtroRepartidor');
                    select.innerHTML = '<option value="">Todos</option>' + 
                        data.repartidores.map(rep => 
                            `<option value="${rep.id}">${rep.nombre} (${rep.id})</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error al cargar repartidores:', error);
            }
        }

        // Cargar comercios para el select
        async function cargarComercios() {
            try {
                const response = await fetch('/api/listar-comercios');
                const data = await response.json();

                if (data.success) {
                    const select = document.getElementById('comercioId');
                    select.innerHTML = '<option value="">Seleccionar comercio (opcional)</option>' +
                        data.comercios.map(com => 
                            `<option value="${com.id}">${com.nombre}</option>`
                        ).join('');
                    
                    // Cargar carrusel de comercios
                    cargarCarruselComercios(data.comercios);
                }
            } catch (error) {
                console.error('Error al cargar comercios:', error);
            }
        }

        // Cargar carrusel de comercios
        function cargarCarruselComercios(comercios) {
            const carousel = document.getElementById('comerciosCarousel');
            
            if (!comercios || comercios.length === 0) {
                carousel.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #94a3b8; width: 100%;">
                        <p style="font-size: 16px; margin-bottom: 10px;">üè™ No hay comercios disponibles</p>
                        <p style="font-size: 13px;">Los comercios aparecer√°n aqu√≠ una vez registrados</p>
                    </div>
                `;
                return;
            }

            // Mapeo de categor√≠as a emojis
            const categoriasEmoji = {
                'alimentacion': 'üçï',
                'kiosco': 'üç¨',
                'bazar': 'üé®',
                'indumentaria': 'üëï',
                'salud': 'üíä',
                'otros': 'üè™',
                'prioridad': '‚≠ê'
            };

            carousel.innerHTML = comercios.map(comercio => {
                const emoji = categoriasEmoji[comercio.categoria] || 'üè™';
                const categoria = comercio.categoria ? comercio.categoria.charAt(0).toUpperCase() + comercio.categoria.slice(1) : 'General';
                
                return `
                    <div class="comercio-card" data-comercio-id="${comercio.id}" onclick="seleccionarComercio('${comercio.id}', '${comercio.nombre}')">
                        <div class="comercio-card-header">
                            ${emoji}
                        </div>
                        <div class="comercio-card-body">
                            <div class="comercio-card-nombre" title="${comercio.nombre}">
                                ${comercio.nombre}
                            </div>
                            <div class="comercio-card-categoria">
                                ${categoria}
                            </div>
                            <div class="comercio-card-info" title="${comercio.direccion || 'Sin direcci√≥n'}">
                                üìç ${comercio.direccion || 'Sin direcci√≥n'}
                            </div>
                            <div class="comercio-card-info">
                                üìû ${comercio.telefono || 'Sin tel√©fono'}
                            </div>
                            <div class="comercio-card-actions">
                                <button class="comercio-btn comercio-btn-select" onclick="event.stopPropagation(); seleccionarComercio('${comercio.id}', '${comercio.nombre}')">
                                    Seleccionar
                                </button>
                                <button class="comercio-btn comercio-btn-visit" onclick="event.stopPropagation(); visitarTienda('${comercio.id}')">
                                    Ver Tienda
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Seleccionar comercio
        let comercioSeleccionadoActual = null;

        function seleccionarComercio(comercioId, comercioNombre) {
            // Actualizar select oculto
            const select = document.getElementById('comercioId');
            select.value = comercioId;

            // Actualizar indicador visual
            const indicador = document.getElementById('comercioSeleccionadoNombre');
            indicador.textContent = comercioNombre;

            // Actualizar tarjetas del carrusel
            document.querySelectorAll('.comercio-card').forEach(card => {
                card.classList.remove('selected');
            });

            const cardSeleccionada = document.querySelector(`[data-comercio-id="${comercioId}"]`);
            if (cardSeleccionada) {
                cardSeleccionada.classList.add('selected');
            }

            comercioSeleccionadoActual = comercioId;
            
            console.log('Comercio seleccionado:', comercioId, comercioNombre);
        }

        // Visitar tienda del comercio
        function visitarTienda(comercioId) {
            // Aqu√≠ puedes abrir un modal o redirigir a la p√°gina de la tienda
            alert(`Funci√≥n "Visitar Tienda" para comercio ID: ${comercioId}\n\n(Pr√≥ximamente: se abrir√° el cat√°logo de productos del comercio)`);
            // Ejemplo de redirecci√≥n:
            // window.location.href = `/tienda-comercio.html?id=${comercioId}`;
        }

        // Scroll del carrusel
        function scrollCarousel(direction) {
            const carousel = document.getElementById('comerciosCarousel');
            const scrollAmount = 220; // Ancho de la tarjeta + gap

            if (direction === 'prev') {
                carousel.scrollLeft -= scrollAmount;
            } else {
                carousel.scrollLeft += scrollAmount;
            }
        }

        // Cargar datos iniciales
        cargarComercios();
    </script>
</body>
</html>
