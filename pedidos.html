<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YaVoy - Gesti√≥n de Pedidos</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
            --bg-primary: #0f1724;
            --bg-secondary: #1a2332;
            --bg-card: rgba(11, 18, 32, 0.85);
            --text-primary: #e6eef6;
            --text-secondary: #ffffff;
            --border-color: #3a4a5c;
            --color-primario: #06b6d4;
            --color-gold: #fbbf24;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-info: #3b82f6;
        }

        body {
            background: linear-gradient(180deg, var(--bg-primary), #071021);
            color: var(--text-primary);
            margin: 0;
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, rgba(11, 18, 32, 0.95), rgba(6, 182, 212, 0.1));
            backdrop-filter: blur(20px);
            padding: 15px 0;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.2);
            border-bottom: 1px solid rgba(6, 182, 212, 0.3);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-container h1 {
            color: var(--text-secondary);
            margin: 0;
        }

        .pedidos-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab {
            padding: 12px 24px;
            background: rgba(248, 250, 252, 0.05);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .tab::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--color-primario), var(--color-gold));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .tab:hover {
            color: var(--color-primario);
            background: rgba(6, 182, 212, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.2);
        }

        .tab.active {
            color: var(--color-primario);
            background: rgba(6, 182, 212, 0.15);
            border-color: var(--color-primario);
        }

        .tab.active::before {
            transform: scaleX(1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h2,
        .tab-content h3 {
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #8899aa;
        }

        .form-group select {
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .form-group select option {
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .productos-list {
            margin-bottom: 15px;
        }

        .producto-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 5px;
        }

        .producto-item input {
            flex: 1;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
        }

        .pedidos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pedido-card {
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 12px;
            padding: 20px;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .pedido-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--color-primario), var(--color-gold));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .pedido-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(6, 182, 212, 0.3);
            border-color: var(--color-primario);
        }

        .pedido-card:hover::before {
            opacity: 1;
        }

        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(6, 182, 212, 0.2);
        }

        /* Timeline de Progreso del Pedido */
        .pedido-timeline {
            margin: 20px 0;
            padding: 15px;
            background: rgba(248, 250, 252, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        .timeline-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin: 20px 0;
        }

        .timeline-line {
            position: absolute;
            top: 15px;
            left: 40px;
            right: 40px;
            height: 3px;
            background: rgba(6, 182, 212, 0.2);
            z-index: 0;
        }

        .timeline-line-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--color-primario), var(--color-gold));
            transition: width 0.5s ease;
        }

        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            z-index: 1;
            position: relative;
        }

        .timeline-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(248, 250, 252, 0.05);
            border: 3px solid rgba(6, 182, 212, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .timeline-step.active .timeline-icon {
            background: linear-gradient(135deg, var(--color-primario), var(--color-gold));
            border-color: var(--color-gold);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
            animation: pulse 2s infinite;
        }

        .timeline-step.completed .timeline-icon {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
        }

        .timeline-label {
            font-size: 11px;
            color: var(--text-primary);
            text-align: center;
            font-weight: 600;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Calculadora de Costo de Env√≠o */
        .costo-calculator {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(251, 191, 36, 0.1));
            border-radius: 12px;
            border: 2px solid rgba(6, 182, 212, 0.3);
        }

        .costo-calculator h4 {
            margin: 0 0 15px 0;
            color: var(--color-primario);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }

        .costo-input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }

        .costo-input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 600;
        }

        .costo-result {
            padding: 15px;
            background: rgba(251, 191, 36, 0.1);
            border-radius: 8px;
            border: 2px solid var(--color-gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .costo-breakdown {
            font-size: 13px;
            color: var(--text-primary);
        }

        .costo-total {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-gold);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            min-width: 300px;
            padding: 15px 20px;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            border: 1px solid rgba(6, 182, 212, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-success {
            border-left: 4px solid var(--color-success);
        }

        .toast-info {
            border-left: 4px solid var(--color-primario);
        }

        .toast-warning {
            border-left: 4px solid var(--color-warning);
        }

        .toast-error {
            border-left: 4px solid var(--color-danger);
        }

        .toast-icon {
            font-size: 24px;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-primary);
        }

        .toast-close {
            cursor: pointer;
            font-size: 20px;
            color: var(--text-primary);
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        .toast-close:hover {
            opacity: 1;
        }

        .pedido-id {
            font-weight: bold;
            color: var(--text-secondary);
        }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .badge::before {
            content: '‚óè';
            font-size: 10px;
        }

        .badge-pendiente {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #000;
        }

        .badge-aceptado {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .badge-en-camino {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
        }

        .badge-entregado {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .badge-cancelado {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .badge-asignado {
            background: #17a2b8;
            color: white;
        }

        .badge-en-camino {
            background: #007bff;
            color: white;
        }

        .badge-entregado {
            background: #28a745;
            color: white;
        }

        .badge-cancelado {
            background: #dc3545;
            color: white;
        }

        .pedido-info p {
            margin: 5px 0;
            font-size: 14px;
            color: var(--text-primary);
        }

        .pedido-info p strong {
            color: var(--text-secondary);
        }

        .pedido-productos {
            margin: 10px 0;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 5px;
        }

        .pedido-productos strong {
            color: var(--text-secondary);
        }

        .pedido-productos ul {
            margin: 5px 0;
            padding-left: 20px;
            color: var(--text-primary);
        }

        .pedido-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .chat-container {
            margin-top: 15px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .chat-messages {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 5px;
        }

        .mensaje {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
        }

        .mensaje-cliente {
            background: #1e3a5f;
            text-align: left;
        }

        .mensaje-repartidor {
            background: #3d3416;
            text-align: right;
        }

        .mensaje-remitente {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 3px;
            color: var(--text-secondary);
        }

        .mensaje-texto {
            font-size: 14px;
            color: var(--text-primary);
        }

        .mensaje-tiempo {
            font-size: 11px;
            color: #8899aa;
            margin-top: 3px;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
        }

        .chat-input select {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 5px;
            min-width: 120px;
        }

        .chat-input select option {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .filtros {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 5px;
        }

        .filtro-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filtro-item label {
            font-size: 12px;
            font-weight: bold;
            color: var(--text-secondary);
        }

        .filtro-item select {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
        }

        .filtro-item select option {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            padding: 15px;
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: var(--color-primario);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-primary);
            margin-top: 5px;
        }

        .repartidor-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: var(--bg-card);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .repartidor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .repartidor-header strong {
            color: var(--text-secondary);
        }

        .repartidor-header small {
            color: var(--text-primary);
        }

        .repartidor-card p {
            color: var(--text-primary);
        }

        .repartidor-card p strong {
            color: var(--text-secondary);
        }

        .disponible-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .disponible-si {
            background: #28a745;
            color: white;
        }

        .disponible-no {
            background: #dc3545;
            color: white;
        }

        /* Modo d√≠a */
        @media (prefers-color-scheme: light) {
            :root {
                --bg-primary: #f5f7fa;
                --bg-secondary: #ffffff;
                --bg-card: #ffffff;
                --text-primary: #2c3e50;
                --text-secondary: #1a252f;
                --border-color: #dee2e6;
                --color-primario: #0056b3;
            }

            body {
                background: linear-gradient(180deg, #f5f7fa, #e9ecef);
            }

            .navbar {
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }

            .pedido-card,
            .stat-card,
            .repartidor-card {
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }

            .form-group input::placeholder,
            .form-group textarea::placeholder {
                color: #6c757d;
            }

            .mensaje-cliente {
                background: #e3f2fd;
            }

            .mensaje-repartidor {
                background: #fff3cd;
            }

            .mensaje-tiempo {
                color: #6c757d;
            }

            .chat-messages {
                background: #f8f9fa;
            }

            .pedido-productos {
                background: #f8f9fa;
            }

            .producto-item {
                background: #f8f9fa;
            }

            .filtros {
                background: #f8f9fa;
            }
        }

        /* ==================== CLASES UTILITARIAS ==================== */
        .section-label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .section-label-icon {
            font-size: 18px;
        }

        .section-label-hint {
            font-size: 12px;
            color: #94a3b8;
            font-weight: normal;
        }

        .loading-text {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .info-box {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }

        .info-box-comercio {
            background: rgba(6, 182, 212, 0.1);
            border-left: 3px solid #06b6d4;
        }

        .info-box-repartidor {
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid #10b981;
        }

        .info-box p {
            margin: 0;
            font-size: 13px;
            color: #94a3b8;
        }

        .info-box strong {
            color: #ffffff;
        }

        #comercioSeleccionadoNombre {
            color: #06b6d4;
        }

        #repartidorSeleccionadoNombre {
            color: #10b981;
        }

        .hidden-group {
            display: none;
        }

        .tab-description {
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        /* ==================== ESTILOS PODIO TOP 10 ==================== */
        .ranking-section {
            padding: 20px 0;
        }

        .ranking-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .ranking-header h2 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #ffd700, #ff6b35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .ranking-header p {
            color: var(--text-primary);
            opacity: 0.8;
        }

        /* Podio Top 3 */
        .podio-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 15px;
            margin-bottom: 40px;
            padding: 20px;
        }

        .podio-place {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border-radius: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .podio-place:hover {
            transform: translateY(-10px);
        }

        .podio-1 {
            background: linear-gradient(145deg, #ffd700, #ffaa00);
            order: 2;
            padding-bottom: 60px;
            min-height: 220px;
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.4);
        }

        .podio-2 {
            background: linear-gradient(145deg, #c0c0c0, #a8a8a8);
            order: 1;
            padding-bottom: 40px;
            min-height: 180px;
            box-shadow: 0 10px 30px rgba(192, 192, 192, 0.4);
        }

        .podio-3 {
            background: linear-gradient(145deg, #cd7f32, #b8690c);
            order: 3;
            padding-bottom: 30px;
            min-height: 160px;
            box-shadow: 0 10px 30px rgba(205, 127, 50, 0.4);
        }

        .podio-medal {
            font-size: 2.5rem;
            margin-bottom: 10px;
            animation: pulse 2s infinite;
        }

        .podio-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin-bottom: 10px;
            border: 3px solid rgba(255,255,255,0.5);
        }

        .podio-1 .podio-avatar {
            width: 90px;
            height: 90px;
            font-size: 2.5rem;
        }

        .podio-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #1a1a1a;
            text-align: center;
            margin-bottom: 5px;
        }

        .podio-stats {
            font-size: 0.9rem;
            color: rgba(0,0,0,0.7);
            text-align: center;
        }

        .podio-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            margin-top: 8px;
        }

        .podio-entregas {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        /* Lista Top 4-10 */
        .ranking-list {
            max-width: 700px;
            margin: 0 auto;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .ranking-item:hover {
            transform: translateX(10px);
            border-color: var(--color-primario);
            box-shadow: 0 5px 20px rgba(6, 182, 212, 0.2);
        }

        .ranking-position {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--color-primario);
            min-width: 40px;
            text-align: center;
        }

        .ranking-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-primario), #3b82f6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .ranking-info {
            flex: 1;
        }

        .ranking-name {
            font-weight: bold;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }

        .ranking-details {
            font-size: 0.85rem;
            color: var(--text-primary);
            opacity: 0.8;
        }

        .ranking-score {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .ranking-stars {
            font-weight: bold;
            color: #ffd700;
            font-size: 1.1rem;
        }

        .ranking-total {
            font-size: 0.8rem;
            color: var(--text-primary);
            opacity: 0.7;
        }

        /* Selector de repartidor preferido */
        .repartidor-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .repartidor-option {
            padding: 12px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .repartidor-option:hover {
            border-color: var(--color-primario);
            transform: translateY(-3px);
        }

        .repartidor-option.selected {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .repartidor-option .rep-avatar {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .repartidor-option .rep-name {
            font-weight: bold;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .repartidor-option .rep-rating {
            font-size: 0.8rem;
            color: #ffd700;
            margin-top: 5px;
        }

        .repartidor-option .rep-entregas {
            font-size: 0.75rem;
            color: var(--text-primary);
            opacity: 0.7;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @media (max-width: 600px) {
            .podio-container {
                flex-direction: column;
                align-items: center;
            }
            .podio-1, .podio-2, .podio-3 {
                order: unset;
                min-height: 0;
                width: 100%;
                max-width: 200px;
            }
        }

        /* Estilos del Carrusel de Comercios */
        .comercios-carousel-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .comercios-carousel {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding: 15px 5px;
            flex: 1;
        }

        /* Scrollbar moderno para navegadores compatibles */
        @supports (scrollbar-width: thin) {
            .comercios-carousel {
                scrollbar-width: thin;
                scrollbar-color: #06b6d4 var(--bg-secondary);
            }
        }

        .comercios-carousel::-webkit-scrollbar {
            height: 8px;
        }

        .comercios-carousel::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .comercios-carousel::-webkit-scrollbar-thumb {
            background: #06b6d4;
            border-radius: 4px;
        }

        .comercios-carousel::-webkit-scrollbar-thumb:hover {
            background: #0891b2;
        }

        .comercio-card {
            min-width: 200px;
            max-width: 200px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .comercio-card:hover {
            transform: translateY(-5px);
            border-color: #06b6d4;
            box-shadow: 0 8px 20px rgba(6, 182, 212, 0.3);
        }

        .comercio-card.selected {
            border-color: #06b6d4;
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
            background: linear-gradient(135deg, var(--bg-secondary), rgba(6, 182, 212, 0.1));
        }

        .comercio-card-header {
            height: 80px;
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            position: relative;
        }

        .comercio-card.selected .comercio-card-header::after {
            content: '‚úì';
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
        }

        .comercio-card-body {
            padding: 12px;
        }

        .comercio-card-nombre {
            font-weight: bold;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .comercio-card-categoria {
            font-size: 11px;
            color: #06b6d4;
            background: rgba(6, 182, 212, 0.15);
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 8px;
        }

        .comercio-card-info {
            font-size: 11px;
            color: #94a3b8;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .comercio-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .comercio-btn {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .comercio-btn-select {
            background: #06b6d4;
            color: white;
        }

        .comercio-btn-select:hover {
            background: #0891b2;
            transform: scale(1.05);
        }

        .comercio-btn-visit {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .comercio-btn-visit:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #06b6d4;
        }

        .carousel-btn {
            width: 40px;
            height: 40px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            color: #06b6d4;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .carousel-btn:hover {
            background: #06b6d4;
            color: white;
            transform: scale(1.1);
        }

        .carousel-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .carousel-btn:disabled:hover {
            background: var(--bg-secondary);
            color: #06b6d4;
            transform: scale(1);
        }

        @media (max-width: 768px) {
            .comercio-card {
                min-width: 160px;
                max-width: 160px;
            }

            .carousel-btn {
                display: none;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1>üöÄ YaVoy - Gesti√≥n de Pedidos</h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <a href="panel-cliente-pro.html" class="btn" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);">
                    üîê Ingresar Sesi√≥n
                </a>
                <a href="index.html" class="btn btn-secondary">‚Üê Volver</a>
            </div>
        </div>
    </nav>

    <div class="pedidos-container">
        <div class="tabs">
            <button class="tab active" data-tab="crear">Crear Pedido</button>
            <button class="tab" data-tab="lista">Lista de Pedidos Disponibles</button>
            <button class="tab" data-tab="pendientes">Pedidos Pendientes</button>
            <button class="tab" data-tab="repartidores">üèÜ Top Repartidores</button>
        </div>

        <!-- TAB: CREAR PEDIDO -->
        <div id="crear" class="tab-content active">
            <h2>Crear Nuevo Pedido</h2>
            <form id="formCrearPedido">
                <div class="form-group">
                    <label for="clienteNombre">Nombre del Cliente *</label>
                    <input type="text" id="clienteNombre" placeholder="Ej: Juan P√©rez" required>
                </div>

                <div class="form-group">
                    <label for="clienteTelefono">Tel√©fono del Cliente</label>
                    <input type="tel" id="clienteTelefono" placeholder="Ej: 555-123-4567">
                </div>

                <div class="form-group">
                    <label for="direccion">Direcci√≥n de Entrega *</label>
                    <textarea id="direccion" rows="3" placeholder="Calle, n√∫mero, colonia, ciudad..." required></textarea>
                </div>

                <!-- Calculadora de Costo de Env√≠o -->
                <div class="costo-calculator">
                    <h4>
                        üí∞ Calculadora de Costo de Env√≠o
                        <span class="help-icon">
                            ?
                            <div class="help-tooltip">
                                <strong>¬øC√≥mo funciona?</strong>
                                Ingresa la distancia en kil√≥metros desde tu ubicaci√≥n hasta donde quieres que llegue el pedido.
                                <br><br>
                                <span class="emoji">üìç</span> <strong>Costo base:</strong> $1000 por 1km<br>
                                <span class="emoji">‚ûï</span> <strong>Adicional:</strong> $100 por cada 100m<br>
                                <span class="emoji">üíµ</span> <strong>Repartidor gana:</strong> 85% del env√≠o<br>
                                <br>
                                <em style="opacity: 0.8;">Esta es una estimaci√≥n. El costo final se calcular√° en tiempo real con GPS.</em>
                            </div>
                        </span>
                    </h4>
                    <div class="costo-input-group">
                        <div style="flex: 1;">
                            <label style="font-size: 12px; color: var(--text-primary); margin-bottom: 5px; display: block;">Distancia (km)</label>
                            <input type="number" id="distanciaKm" placeholder="Ej: 2.5" step="0.1" min="0" value="1">
                        </div>
                        <button type="button" class="btn btn-primary" onclick="calcularCostoEnvio()">Calcular</button>
                    </div>
                    <div class="costo-result" id="costoResult" style="display: none;">
                        <div class="costo-breakdown">
                            <div style="margin-bottom: 8px;">
                                <strong>C√°lculo:</strong><br>
                                <span id="costoFormula" style="color: var(--color-primario);"></span>
                            </div>
                            <div style="font-size: 11px; opacity: 0.8;">
                                Repartidor gana (85%): <span id="costoRepartidor" style="color: var(--color-gold);"></span>
                            </div>
                        </div>
                        <div class="costo-total" id="costoTotal">$0</div>
                    </div>
                </div>

                <!-- Carrusel de Comercios Disponibles -->
                <div class="form-group">
                    <label class="section-label">
                        <span class="section-label-icon">üè™ Comercios Disponibles</span>
                        <span class="section-label-hint">(Selecciona uno o visita su tienda)</span>
                    </label>
                    
                    <div class="comercios-carousel-wrapper">
                        <button type="button" class="carousel-btn carousel-prev" onclick="scrollCarousel('prev')" aria-label="Anterior">
                            ‚Äπ
                        </button>
                        
                        <div class="comercios-carousel" id="comerciosCarousel">
                            <!-- Los comercios se cargar√°n din√°micamente aqu√≠ -->
                            <div class="comercio-loading loading-text">
                                Cargando comercios...
                            </div>
                        </div>
                        
                        <button type="button" class="carousel-btn carousel-next" onclick="scrollCarousel('next')" aria-label="Siguiente">
                            ‚Ä∫
                        </button>
                    </div>
                    
                    <div class="info-box info-box-comercio">
                        <p>
                            üí° <strong>Comercio seleccionado:</strong> 
                            <span id="comercioSeleccionadoNombre">Ninguno</span>
                        </p>
                    </div>
                </div>

                <div class="form-group hidden-group">
                    <label>Comercio</label>
                    <select id="comercioId">
                        <option value="">Seleccionar comercio (opcional)</option>
                    </select>
                </div>

                <!-- Selector de Repartidor Preferido -->
                <div class="form-group">
                    <label class="section-label">
                        <span class="section-label-icon">üèÜ Elige tu Repartidor Preferido</span>
                        <span class="section-label-hint">(Opcional - Top calificados)</span>
                    </label>
                    
                    <div class="repartidor-selector" id="repartidorSelector">
                        <!-- Se llena din√°micamente -->
                        <div class="loading-text">
                            Cargando repartidores...
                        </div>
                    </div>
                    
                    <div class="info-box info-box-repartidor">
                        <p>
                            ‚≠ê <strong>Repartidor elegido:</strong> 
                            <span id="repartidorSeleccionadoNombre">Cualquiera disponible</span>
                        </p>
                    </div>
                    <input type="hidden" id="repartidorPreferido" value="">
                </div>

                <div class="form-group">
                    <label>Productos</label>
                    <div class="productos-list" id="productosList">
                        <div class="producto-item">
                            <input type="text" placeholder="Nombre del producto" class="producto-nombre">
                            <input type="number" placeholder="Cantidad" class="producto-cantidad" min="1" value="1">
                            <input type="number" placeholder="Precio" class="producto-precio" step="0.01" min="0">
                            <button type="button" class="btn btn-danger" onclick="eliminarProducto(this)">-</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="agregarProducto()">+ Agregar Producto</button>
                </div>

                <div class="form-group">
                    <label for="total">Total $</label>
                    <input type="number" id="total" step="0.01" min="0" placeholder="0.00" required>
                </div>

                <button type="submit" class="btn btn-primary">Crear Pedido</button>
            </form>
        </div>

        <!-- TAB: LISTA DE PEDIDOS DISPONIBLES -->
        <div id="lista" class="tab-content">
            <h2>Pedidos Disponibles para Asignar</h2>
            <p class="tab-description">Estos son los pedidos que a√∫n no han sido tomados por ning√∫n repartidor.</p>
            
            <div class="pedidos-grid" id="pedidosDisponiblesGrid"></div>
        </div>

        <!-- TAB: PEDIDOS PENDIENTES (ASIGNADOS) -->
        <div id="pendientes" class="tab-content">
            <h2>Pedidos Pendientes de Entrega</h2>
            <p class="tab-description">Pedidos que ya fueron asignados a repartidores y est√°n en proceso.</p>
            
            <div class="stats" id="statsPendientesContainer"></div>

            <div class="filtros">
                <div class="filtro-item">
                    <label>Estado</label>
                    <select id="filtroPendientesEstado">
                        <option value="">Todos</option>
                        <option value="asignado">Asignados</option>
                        <option value="en-camino">En Camino</option>
                        <option value="entregado">Entregados</option>
                    </select>
                </div>
                <div class="filtro-item">
                    <label>Repartidor</label>
                    <select id="filtroPendientesRepartidor">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filtro-item">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="cargarPedidosPendientes()">Filtrar</button>
                </div>
            </div>

            <div class="pedidos-grid" id="pedidosPendientesGrid"></div>
        </div>

        <!-- TAB: TOP REPARTIDORES (RANKING) -->
        <div id="repartidores" class="tab-content">
            <div class="ranking-section">
                <div class="ranking-header">
                    <h2>üèÜ Top 10 Mejores Repartidores</h2>
                    <p>Los h√©roes que hacen posible tus entregas ‚Ä¢ Clasificados por calificaci√≥n y entregas</p>
                </div>

                <!-- Podio Top 3 -->
                <div class="podio-container" id="podioTop3">
                    <!-- Se llena din√°micamente -->
                </div>

                <!-- Lista 4-10 -->
                <div class="ranking-list" id="rankingList">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sistema de tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                
                // Desactivar todos los tabs y contenidos
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Activar tab y contenido seleccionado
                tab.classList.add('active');
                document.getElementById(tabId).classList.add('active');

                // Cargar datos seg√∫n el tab
                if (tabId === 'lista') {
                    cargarPedidosDisponibles();
                } else if (tabId === 'pendientes') {
                    cargarPedidosPendientes();
                    cargarRepartidoresParaFiltroPendientes();
                } else if (tabId === 'repartidores') {
                    cargarRepartidores();
                }
            });
        });

        // Gesti√≥n de productos en el formulario
        function agregarProducto() {
            const productoHTML = `
                <div class="producto-item">
                    <input type="text" placeholder="Nombre del producto" class="producto-nombre">
                    <input type="number" placeholder="Cantidad" class="producto-cantidad" min="1" value="1">
                    <input type="number" placeholder="Precio" class="producto-precio" step="0.01" min="0">
                    <button type="button" class="btn btn-danger" onclick="eliminarProducto(this)">-</button>
                </div>
            `;
            document.getElementById('productosList').insertAdjacentHTML('beforeend', productoHTML);
        }

        function eliminarProducto(btn) {
            if (document.querySelectorAll('.producto-item').length > 1) {
                btn.closest('.producto-item').remove();
            } else {
                alert('Debe haber al menos un producto');
            }
        }

        // Crear pedido
        document.getElementById('formCrearPedido').addEventListener('submit', async (e) => {
            e.preventDefault();

            const productos = [];
            document.querySelectorAll('.producto-item').forEach(item => {
                const nombre = item.querySelector('.producto-nombre').value;
                const cantidad = parseInt(item.querySelector('.producto-cantidad').value);
                const precio = parseFloat(item.querySelector('.producto-precio').value);
                
                if (nombre && cantidad && precio) {
                    productos.push({ nombre, cantidad, precio });
                }
            });

            if (productos.length === 0) {
                alert('Debe agregar al menos un producto v√°lido');
                return;
            }

            const pedido = {
                clienteNombre: document.getElementById('clienteNombre').value,
                clienteTelefono: document.getElementById('clienteTelefono').value,
                direccion: document.getElementById('direccion').value,
                comercioId: document.getElementById('comercioId').value,
                productos: productos,
                total: parseFloat(document.getElementById('total').value),
                repartidorPreferido: document.getElementById('repartidorPreferido').value || null
            };

            try {
                const response = await fetch('/api/pedidos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pedido)
                });

                const data = await response.json();

                if (data.success) {
                    // Calcular costo de env√≠o y ganancia del repartidor
                    const costoEnvio = data.pedido.costo_envio || 1000;
                    const gananciasRepartidor = Math.round(costoEnvio * 0.85);
                    
                    showToast('success', '‚úì Pedido Creado', 
                        `Pedido #${data.pedido.id} creado exitosamente. Costo de env√≠o: $${costoEnvio.toLocaleString()}`);
                    
                    // Limpiar borrador guardado
                    limpiarBorradorLocal();
                    
                    document.getElementById('formCrearPedido').reset();
                    document.getElementById('productosList').innerHTML = `
                        <div class="producto-item">
                            <input type="text" placeholder="Nombre del producto" class="producto-nombre">
                            <input type="number" placeholder="Cantidad" class="producto-cantidad" min="1" value="1">
                            <input type="number" placeholder="Precio" class="producto-precio" step="0.01" min="0">
                            <button type="button" class="btn btn-danger" onclick="eliminarProducto(this)">-</button>
                        </div>
                    `;
                    // Resetear selectores
                    document.getElementById('comercioSeleccionadoNombre').textContent = 'Ninguno';
                    document.getElementById('repartidorPreferido').value = '';
                    document.getElementById('repartidorSeleccionadoNombre').textContent = 'Cualquiera disponible';
                    cargarSelectorRepartidores();
                } else {
                    showToast('danger', '‚úó Error', data.error || 'No se pudo crear el pedido');
                }
            } catch (error) {
                showToast('danger', '‚úó Error de Conexi√≥n', error.message);
            }
        });

        // Cargar pedidos
        // Cargar pedidos disponibles (solo estado pendiente)
        async function cargarPedidosDisponibles() {
            try {
                const response = await fetch('/api/pedidos?estado=pendiente');
                const data = await response.json();

                if (data.success) {
                    mostrarPedidosDisponibles(data.pedidos);
                }
            } catch (error) {
                console.error('Error al cargar pedidos disponibles:', error);
            }
        }

        function mostrarPedidosDisponibles(pedidos) {
            const grid = document.getElementById('pedidosDisponiblesGrid');
            
            if (pedidos.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-primary); text-align: center; padding: 40px;">No hay pedidos disponibles en este momento</p>';
                return;
            }

            grid.innerHTML = pedidos.map(pedido => `
                <div class="pedido-card">
                    <div class="pedido-header">
                        <span class="pedido-id">${pedido.id}</span>
                        <span class="badge badge-pendiente">DISPONIBLE</span>
                    </div>
                    <div class="pedido-info">
                        <p><strong>Cliente:</strong> ${pedido.clienteNombre}</p>
                        <p><strong>Direcci√≥n de Entrega:</strong> ${pedido.direccion}</p>
                        <div class="pedido-productos">
                            <strong>Productos:</strong>
                            <ul>
                                ${pedido.productos.map(p => `<li>${p.nombre} x${p.cantidad} - $${p.precio}</li>`).join('')}
                            </ul>
                        </div>
                        <p><strong>Total:</strong> $${pedido.total}</p>
                        <p><strong>Creado:</strong> ${new Date(pedido.createdAt).toLocaleString()}</p>
                    </div>
                    <div class="pedido-actions">
                        <button class="btn btn-success" onclick="tomarPedido('${pedido.id}')" style="width: 100%;">üöÄ Tomar Pedido</button>
                    </div>
                </div>
            `).join('');
        }

        // Tomar pedido (asignar repartidor)
        async function tomarPedido(pedidoId) {
            const repartidorId = prompt('Ingrese su ID de repartidor:');
            if (!repartidorId) return;

            try {
                const response = await fetch(`/api/pedidos/${pedidoId}/asignar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ repartidorId })
                });

                const data = await response.json();
                if (data.success) {
                    alert('‚úì Pedido tomado exitosamente. Ahora aparecer√° en "Pedidos Pendientes"');
                    cargarPedidosDisponibles();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Cargar pedidos pendientes (asignados, en-camino, entregados)
        async function cargarPedidosPendientes() {
            const estado = document.getElementById('filtroPendientesEstado').value;
            const repartidorId = document.getElementById('filtroPendientesRepartidor').value;

            let url = '/api/pedidos?';
            const filtros = [];
            
            // Filtrar estados que NO sean pendiente
            if (estado) {
                filtros.push(`estado=${estado}`);
            } else {
                // Si no se especifica, mostrar asignado, en-camino y entregado
                filtros.push('estado=asignado,en-camino,entregado');
            }
            
            if (repartidorId) {
                filtros.push(`repartidorId=${repartidorId}`);
            }

            url += filtros.join('&');

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    // Filtrar solo pedidos que NO est√©n en pendiente
                    const pedidosPendientes = data.pedidos.filter(p => p.estado !== 'pendiente');
                    mostrarPedidosPendientes(pedidosPendientes);
                    mostrarEstadisticasPendientes(pedidosPendientes);
                }
            } catch (error) {
                console.error('Error al cargar pedidos pendientes:', error);
            }
        }

        function mostrarEstadisticasPendientes(pedidos) {
            const stats = {
                total: pedidos.length,
                asignados: pedidos.filter(p => p.estado === 'asignado').length,
                enCamino: pedidos.filter(p => p.estado === 'en-camino').length,
                entregados: pedidos.filter(p => p.estado === 'entregado').length
            };

            document.getElementById('statsPendientesContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Total Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.asignados}</div>
                    <div class="stat-label">Asignados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.enCamino}</div>
                    <div class="stat-label">En Camino</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.entregados}</div>
                    <div class="stat-label">Entregados</div>
                </div>
            `;
        }

        function mostrarPedidosPendientes(pedidos) {
            const grid = document.getElementById('pedidosPendientesGrid');
            
            if (pedidos.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-primary); text-align: center; padding: 40px;">No hay pedidos pendientes</p>';
                return;
            }

            grid.innerHTML = pedidos.map(pedido => `
                <div class="pedido-card">
                    <div class="pedido-header">
                        <span class="pedido-id">${pedido.id}</span>
                        <span class="badge badge-${pedido.estado}">${pedido.estado.toUpperCase()}</span>
                    </div>
                    
                    ${renderizarTimeline(pedido.estado)}
                    
                    <div class="pedido-info">
                        <p><strong>Cliente:</strong> ${pedido.clienteNombre}</p>
                        <p><strong>Tel√©fono:</strong> ${pedido.clienteTelefono || 'No especificado'}</p>
                        <p><strong>Direcci√≥n de Entrega:</strong> ${pedido.direccion}</p>
                        <div class="pedido-productos">
                            <strong>Productos:</strong>
                            <ul>
                                ${pedido.productos.map(p => `<li>${p.nombre} x${p.cantidad} - $${p.precio}</li>`).join('')}
                            </ul>
                        </div>
                        <p><strong>Total:</strong> <span style="color: var(--color-gold); font-weight: 700; font-size: 18px;">$${pedido.total.toLocaleString()}</span></p>
                        <p><strong>Repartidor:</strong> ${pedido.repartidorId}</p>
                    </div>
                    <div class="pedido-actions">
                        ${pedido.estado === 'asignado' ? `
                            <button class="btn btn-primary" onclick="cambiarEstado('${pedido.id}', 'en-camino')">üö¥ Salir a Entregar</button>
                        ` : ''}
                        ${pedido.estado === 'en-camino' ? `
                            <button class="btn btn-success" onclick="cambiarEstado('${pedido.id}', 'entregado')">‚úì Marcar Entregado</button>
                        ` : ''}
                        ${pedido.estado === 'entregado' ? `
                            <span style="color: var(--color-success); font-weight: bold; display: flex; align-items: center; gap: 8px;"><span style="font-size: 24px;">‚úì</span> Pedido Completado</span>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="toggleChat('${pedido.id}')">üí¨ Chat</button>
                    </div>
                    <div id="chat-${pedido.id}" class="chat-container" style="display: none;">
                        <div class="chat-messages" id="mensajes-${pedido.id}"></div>
                        <div class="chat-input">
                            <input type="text" id="mensaje-${pedido.id}" placeholder="Escribe un mensaje...">
                            <select id="remitente-${pedido.id}">
                                <option value="cliente">Cliente</option>
                                <option value="repartidor">Repartidor</option>
                            </select>
                            <button class="btn btn-primary" onclick="enviarMensaje('${pedido.id}')">Enviar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function cargarRepartidoresParaFiltroPendientes() {
            try {
                const response = await fetch('/api/repartidores');
                const data = await response.json();

                if (data.success) {
                    const select = document.getElementById('filtroPendientesRepartidor');
                    select.innerHTML = '<option value="">Todos</option>' + 
                        data.repartidores.map(rep => 
                            `<option value="${rep.id}">${rep.nombre} (${rep.id})</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error al cargar repartidores:', error);
            }
        }

        // Funci√≥n legacy - mantener para compatibilidad
        async function cargarPedidos() {
            // Redirigir a la nueva funci√≥n
            await cargarPedidosDisponibles();
        }

        function mostrarEstadisticas(pedidos) {
            const stats = {
                total: pedidos.length,
                pendientes: pedidos.filter(p => p.estado === 'pendiente').length,
                enCamino: pedidos.filter(p => p.estado === 'en-camino').length,
                entregados: pedidos.filter(p => p.estado === 'entregado').length
            };

            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Total Pedidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.pendientes}</div>
                    <div class="stat-label">Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.enCamino}</div>
                    <div class="stat-label">En Camino</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.entregados}</div>
                    <div class="stat-label">Entregados</div>
                </div>
            `;
        }

        function mostrarPedidos(pedidos) {
            const grid = document.getElementById('pedidosGrid');
            
            if (pedidos.length === 0) {
                grid.innerHTML = '<p>No hay pedidos para mostrar</p>';
                return;
            }

            grid.innerHTML = pedidos.map(pedido => `
                <div class="pedido-card">
                    <div class="pedido-header">
                        <span class="pedido-id">${pedido.id}</span>
                        <span class="badge badge-${pedido.estado}">${pedido.estado.toUpperCase()}</span>
                    </div>
                    <div class="pedido-info">
                        <p><strong>Cliente:</strong> ${pedido.clienteNombre}</p>
                        <p><strong>Tel√©fono:</strong> ${pedido.clienteTelefono || 'No especificado'}</p>
                        <p><strong>Direcci√≥n:</strong> ${pedido.direccion}</p>
                        <div class="pedido-productos">
                            <strong>Productos:</strong>
                            <ul>
                                ${pedido.productos.map(p => `<li>${p.nombre} x${p.cantidad} - $${p.precio}</li>`).join('')}
                            </ul>
                        </div>
                        <p><strong>Total:</strong> $${pedido.total}</p>
                        ${pedido.repartidorId ? `<p><strong>Repartidor:</strong> ${pedido.repartidorId}</p>` : ''}
                    </div>
                    <div class="pedido-actions">
                        ${pedido.estado === 'pendiente' ? `
                            <button class="btn btn-primary" onclick="asignarRepartidor('${pedido.id}')">Asignar</button>
                        ` : ''}
                        ${pedido.estado === 'asignado' ? `
                            <button class="btn btn-success" onclick="cambiarEstado('${pedido.id}', 'en-camino')">En Camino</button>
                        ` : ''}
                        ${pedido.estado === 'en-camino' ? `
                            <button class="btn btn-success" onclick="cambiarEstado('${pedido.id}', 'entregado')">Entregar</button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="toggleChat('${pedido.id}')">üí¨ Chat</button>
                    </div>
                    <div id="chat-${pedido.id}" class="chat-container" style="display: none;">
                        <div class="chat-messages" id="mensajes-${pedido.id}"></div>
                        <div class="chat-input">
                            <input type="text" id="mensaje-${pedido.id}" placeholder="Escribe un mensaje...">
                            <select id="remitente-${pedido.id}">
                                <option value="cliente">Cliente</option>
                                <option value="repartidor">Repartidor</option>
                            </select>
                            <button class="btn btn-primary" onclick="enviarMensaje('${pedido.id}')">Enviar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function asignarRepartidor(pedidoId) {
            const repartidorId = prompt('Ingrese el ID del repartidor:');
            if (!repartidorId) return;

            try {
                const response = await fetch(`/api/pedidos/${pedidoId}/asignar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ repartidorId })
                });

                const data = await response.json();
                if (data.success) {
                    alert('‚úì Repartidor asignado');
                    cargarPedidos();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function cambiarEstado(pedidoId, nuevoEstado) {
            try {
                const response = await fetch(`/api/pedidos/${pedidoId}/estado`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ estado: nuevoEstado })
                });

                const data = await response.json();
                if (data.success) {
                    // Mostrar toast de √©xito con el estado correspondiente
                    const estadosNombres = {
                        'pendiente': 'Pendiente',
                        'aceptado': 'Aceptado',
                        'en-camino': 'En Camino',
                        'entregado': 'Entregado'
                    };
                    showToast('success', '‚úì Estado Actualizado', `El pedido ahora est√° en estado: ${estadosNombres[nuevoEstado]}`);
                    // Recargar la lista de pendientes
                    cargarPedidosPendientes();
                } else {
                    showToast('danger', '‚úó Error', data.error || 'No se pudo actualizar el estado');
                }
            } catch (error) {
                showToast('danger', '‚úó Error de Conexi√≥n', error.message);
            }
        }

        async function toggleChat(pedidoId) {
            const chatDiv = document.getElementById(`chat-${pedidoId}`);
            if (chatDiv.style.display === 'none') {
                chatDiv.style.display = 'block';
                await cargarMensajes(pedidoId);
            } else {
                chatDiv.style.display = 'none';
            }
        }

        async function cargarMensajes(pedidoId) {
            try {
                const response = await fetch(`/api/pedidos/${pedidoId}/chat`);
                const data = await response.json();

                if (data.success) {
                    const mensajesDiv = document.getElementById(`mensajes-${pedidoId}`);
                    mensajesDiv.innerHTML = data.mensajes.map(msg => `
                        <div class="mensaje mensaje-${msg.remitente}">
                            <div class="mensaje-remitente">${msg.remitente}</div>
                            <div class="mensaje-texto">${msg.mensaje}</div>
                            <div class="mensaje-tiempo">${new Date(msg.timestamp).toLocaleString()}</div>
                        </div>
                    `).join('');
                    mensajesDiv.scrollTop = mensajesDiv.scrollHeight;
                }
            } catch (error) {
                console.error('Error al cargar mensajes:', error);
            }
        }

        async function enviarMensaje(pedidoId) {
            const mensaje = document.getElementById(`mensaje-${pedidoId}`).value;
            const remitente = document.getElementById(`remitente-${pedidoId}`).value;

            if (!mensaje.trim()) return;

            try {
                const response = await fetch(`/api/pedidos/${pedidoId}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mensaje, remitente })
                });

                const data = await response.json();
                if (data.success) {
                    document.getElementById(`mensaje-${pedidoId}`).value = '';
                    await cargarMensajes(pedidoId);
                }
            } catch (error) {
                alert('Error al enviar mensaje: ' + error.message);
            }
        }

        // Registrar repartidor
        document.getElementById('formRegistrarRepartidor').addEventListener('submit', async (e) => {
            e.preventDefault();

            const repartidor = {
                nombre: document.getElementById('repNombre').value,
                telefono: document.getElementById('repTelefono').value,
                email: document.getElementById('repEmail').value,
                vehiculo: document.getElementById('repVehiculo').value
            };

            try {
                const response = await fetch('/api/repartidores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(repartidor)
                });

                const data = await response.json();
                if (data.success) {
                    alert('‚úì Repartidor registrado: ' + data.repartidor.id);
                    document.getElementById('formRegistrarRepartidor').reset();
                    cargarRepartidores();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        async function cargarRepartidores() {
            try {
                const response = await fetch('/api/repartidores');
                const data = await response.json();

                if (data.success) {
                    const lista = document.getElementById('repartidoresList');
                    lista.innerHTML = data.repartidores.map(rep => `
                        <div class="repartidor-card">
                            <div class="repartidor-header">
                                <div>
                                    <strong>${rep.nombre}</strong> (${rep.id})
                                    <br>
                                    <small>${rep.telefono} ‚Ä¢ ${rep.vehiculo}</small>
                                </div>
                                <span class="disponible-badge ${rep.disponible ? 'disponible-si' : 'disponible-no'}">
                                    ${rep.disponible ? 'Disponible' : 'Ocupado'}
                                </span>
                            </div>
                            <p><strong>Pedidos activos:</strong> ${rep.pedidosActivos}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error al cargar repartidores:', error);
            }
        }

        async function cargarRepartidoresParaFiltro() {
            try {
                const response = await fetch('/api/repartidores');
                const data = await response.json();

                if (data.success) {
                    const select = document.getElementById('filtroRepartidor');
                    select.innerHTML = '<option value="">Todos</option>' + 
                        data.repartidores.map(rep => 
                            `<option value="${rep.id}">${rep.nombre} (${rep.id})</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error al cargar repartidores:', error);
            }
        }

        // Cargar comercios para el select
        async function cargarComercios() {
            try {
                const response = await fetch('/api/listar-comercios');
                const data = await response.json();

                if (data.success) {
                    const select = document.getElementById('comercioId');
                    select.innerHTML = '<option value="">Seleccionar comercio (opcional)</option>' +
                        data.comercios.map(com => 
                            `<option value="${com.id}">${com.nombre}</option>`
                        ).join('');
                    
                    // Cargar carrusel de comercios
                    cargarCarruselComercios(data.comercios);
                }
            } catch (error) {
                console.error('Error al cargar comercios:', error);
            }
        }

        // Cargar carrusel de comercios
        function cargarCarruselComercios(comercios) {
            const carousel = document.getElementById('comerciosCarousel');
            
            if (!comercios || comercios.length === 0) {
                carousel.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #94a3b8; width: 100%;">
                        <p style="font-size: 16px; margin-bottom: 10px;">üè™ No hay comercios disponibles</p>
                        <p style="font-size: 13px;">Los comercios aparecer√°n aqu√≠ una vez registrados</p>
                    </div>
                `;
                return;
            }

            // Mapeo de categor√≠as a emojis
            const categoriasEmoji = {
                'alimentacion': 'üçï',
                'kiosco': 'üç¨',
                'bazar': 'üé®',
                'indumentaria': 'üëï',
                'salud': 'üíä',
                'otros': 'üè™',
                'prioridad': '‚≠ê'
            };

            carousel.innerHTML = comercios.map(comercio => {
                const emoji = categoriasEmoji[comercio.categoria] || 'üè™';
                const categoria = comercio.categoria ? comercio.categoria.charAt(0).toUpperCase() + comercio.categoria.slice(1) : 'General';
                
                return `
                    <div class="comercio-card" data-comercio-id="${comercio.id}" onclick="seleccionarComercio('${comercio.id}', '${comercio.nombre}')">
                        <div class="comercio-card-header">
                            ${emoji}
                        </div>
                        <div class="comercio-card-body">
                            <div class="comercio-card-nombre" title="${comercio.nombre}">
                                ${comercio.nombre}
                            </div>
                            <div class="comercio-card-categoria">
                                ${categoria}
                            </div>
                            <div class="comercio-card-info" title="${comercio.direccion || 'Sin direcci√≥n'}">
                                üìç ${comercio.direccion || 'Sin direcci√≥n'}
                            </div>
                            <div class="comercio-card-info">
                                üìû ${comercio.telefono || 'Sin tel√©fono'}
                            </div>
                            <div class="comercio-card-actions">
                                <button class="comercio-btn comercio-btn-select" onclick="event.stopPropagation(); seleccionarComercio('${comercio.id}', '${comercio.nombre}')">
                                    Seleccionar
                                </button>
                                <button class="comercio-btn comercio-btn-visit" onclick="event.stopPropagation(); visitarTienda('${comercio.id}')">
                                    Ver Tienda
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Seleccionar comercio
        let comercioSeleccionadoActual = null;

        function seleccionarComercio(comercioId, comercioNombre) {
            // Actualizar select oculto
            const select = document.getElementById('comercioId');
            select.value = comercioId;

            // Actualizar indicador visual
            const indicador = document.getElementById('comercioSeleccionadoNombre');
            indicador.textContent = comercioNombre;

            // Actualizar tarjetas del carrusel
            document.querySelectorAll('.comercio-card').forEach(card => {
                card.classList.remove('selected');
            });

            const cardSeleccionada = document.querySelector(`[data-comercio-id="${comercioId}"]`);
            if (cardSeleccionada) {
                cardSeleccionada.classList.add('selected');
            }

            comercioSeleccionadoActual = comercioId;
            
            console.log('Comercio seleccionado:', comercioId, comercioNombre);
        }

        // Visitar tienda del comercio
        function visitarTienda(comercioId) {
            // Aqu√≠ puedes abrir un modal o redirigir a la p√°gina de la tienda
            alert(`Funci√≥n "Visitar Tienda" para comercio ID: ${comercioId}\n\n(Pr√≥ximamente: se abrir√° el cat√°logo de productos del comercio)`);
            // Ejemplo de redirecci√≥n:
            // window.location.href = `/tienda-comercio.html?id=${comercioId}`;
        }

        // Scroll del carrusel
        function scrollCarousel(direction) {
            const carousel = document.getElementById('comerciosCarousel');
            const scrollAmount = 220; // Ancho de la tarjeta + gap

            if (direction === 'prev') {
                carousel.scrollLeft -= scrollAmount;
            } else {
                carousel.scrollLeft += scrollAmount;
            }
        }

        // ==================== SISTEMA DE RANKING Y SELECTOR ====================
        
        // Datos de repartidores con puntuaci√≥n (simulados, luego conectar a API)
        const repartidoresRanking = [
            { id: 'REP001', nombre: 'Carlos Mendoza', avatar: 'üö¥', rating: 4.9, entregas: 342, vehiculo: 'Moto', disponible: true },
            { id: 'REP002', nombre: 'Mar√≠a Garc√≠a', avatar: 'üèçÔ∏è', rating: 4.8, entregas: 289, vehiculo: 'Moto', disponible: true },
            { id: 'REP003', nombre: 'Juan P√©rez', avatar: 'üö≤', rating: 4.7, entregas: 256, vehiculo: 'Bicicleta', disponible: false },
            { id: 'REP004', nombre: 'Ana L√≥pez', avatar: 'üõµ', rating: 4.6, entregas: 198, vehiculo: 'Moto', disponible: true },
            { id: 'REP005', nombre: 'Pedro S√°nchez', avatar: 'üöó', rating: 4.5, entregas: 175, vehiculo: 'Auto', disponible: true },
            { id: 'REP006', nombre: 'Laura Mart√≠nez', avatar: 'üèçÔ∏è', rating: 4.4, entregas: 156, vehiculo: 'Moto', disponible: true },
            { id: 'REP007', nombre: 'Diego Torres', avatar: 'üö¥', rating: 4.3, entregas: 134, vehiculo: 'Bicicleta', disponible: false },
            { id: 'REP008', nombre: 'Sofia Ruiz', avatar: 'üõµ', rating: 4.2, entregas: 112, vehiculo: 'Moto', disponible: true },
            { id: 'REP009', nombre: 'Roberto Castro', avatar: 'üöó', rating: 4.1, entregas: 98, vehiculo: 'Auto', disponible: true },
            { id: 'REP010', nombre: 'Elena Vargas', avatar: 'üèçÔ∏è', rating: 4.0, entregas: 87, vehiculo: 'Moto', disponible: true }
        ];

        // Cargar ranking desde API si existe, sino usar datos simulados
        async function cargarRankingRepartidores() {
            try {
                const response = await fetch('/api/repartidores/ranking');
                if (response.ok) {
                    const data = await response.json();
                    if (data.length > 0) {
                        renderizarPodio(data.slice(0, 10));
                        return;
                    }
                }
            } catch (error) {
                console.log('Usando datos de ranking simulados');
            }
            // Usar datos simulados
            renderizarPodio(repartidoresRanking);
        }

        function renderizarPodio(repartidores) {
            const podioContainer = document.getElementById('podioTop3');
            const rankingList = document.getElementById('rankingList');
            
            if (!podioContainer || !rankingList) return;

            // Top 3 - Podio
            const top3 = repartidores.slice(0, 3);
            const medallas = ['ü•á', 'ü•à', 'ü•â'];
            
            podioContainer.innerHTML = top3.map((rep, i) => `
                <div class="podio-place podio-${i + 1}" onclick="seleccionarRepartidorPreferido('${rep.id}', '${rep.nombre}')">
                    <div class="podio-medal">${medallas[i]}</div>
                    <div class="podio-avatar">${rep.avatar}</div>
                    <div class="podio-name">${rep.nombre}</div>
                    <div class="podio-rating">‚≠ê ${rep.rating}</div>
                    <div class="podio-entregas">${rep.entregas} entregas</div>
                    <div class="podio-stats">${rep.vehiculo}</div>
                </div>
            `).join('');

            // Posiciones 4-10
            const resto = repartidores.slice(3, 10);
            rankingList.innerHTML = resto.map((rep, i) => `
                <div class="ranking-item" onclick="seleccionarRepartidorPreferido('${rep.id}', '${rep.nombre}')">
                    <div class="ranking-position">#${i + 4}</div>
                    <div class="ranking-avatar">${rep.avatar}</div>
                    <div class="ranking-info">
                        <div class="ranking-name">${rep.nombre}</div>
                        <div class="ranking-details">${rep.vehiculo} ‚Ä¢ ${rep.disponible ? 'üü¢ Disponible' : 'üî¥ Ocupado'}</div>
                    </div>
                    <div class="ranking-score">
                        <div class="ranking-stars">‚≠ê ${rep.rating}</div>
                        <div class="ranking-total">${rep.entregas} entregas</div>
                    </div>
                </div>
            `).join('');
        }

        // Cargar selector de repartidores en formulario
        function cargarSelectorRepartidores() {
            const container = document.getElementById('repartidorSelector');
            if (!container) return;

            const disponibles = repartidoresRanking.filter(r => r.disponible).slice(0, 6);
            
            container.innerHTML = `
                <div class="repartidor-option ${!document.getElementById('repartidorPreferido').value ? 'selected' : ''}" 
                     onclick="seleccionarRepartidorPreferido('', 'Cualquiera disponible')">
                    <div class="rep-avatar">üé≤</div>
                    <div class="rep-name">Cualquiera</div>
                    <div class="rep-rating">Autom√°tico</div>
                    <div class="rep-entregas">El m√°s cercano</div>
                </div>
                ${disponibles.map(rep => `
                    <div class="repartidor-option" data-rep-id="${rep.id}" 
                         onclick="seleccionarRepartidorPreferido('${rep.id}', '${rep.nombre}')">
                        <div class="rep-avatar">${rep.avatar}</div>
                        <div class="rep-name">${rep.nombre}</div>
                        <div class="rep-rating">‚≠ê ${rep.rating}</div>
                        <div class="rep-entregas">${rep.entregas} entregas</div>
                    </div>
                `).join('')}
            `;
        }

        // Seleccionar repartidor preferido
        function seleccionarRepartidorPreferido(repId, repNombre) {
            document.getElementById('repartidorPreferido').value = repId;
            document.getElementById('repartidorSeleccionadoNombre').textContent = repNombre;
            
            // Actualizar UI del selector
            document.querySelectorAll('.repartidor-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            if (repId) {
                const selected = document.querySelector(`.repartidor-option[data-rep-id="${repId}"]`);
                if (selected) selected.classList.add('selected');
            } else {
                // Seleccionar "Cualquiera"
                const cualquiera = document.querySelector('.repartidor-option:first-child');
                if (cualquiera) cualquiera.classList.add('selected');
            }
        }

        // Modificar cargarRepartidores para usar el nuevo sistema
        function cargarRepartidores() {
            cargarRankingRepartidores();
        }

        // ========================================
        // üíæ SISTEMA DE AUTO-GUARDADO DEL FORMULARIO
        // ========================================
        
        // Campos que se van a guardar autom√°ticamente
        const camposFormulario = [
            'clienteNombre',
            'clienteTelefono',
            'direccion',
            'comercioId',
            'distanciaKm'
        ];

        // Guardar formulario en localStorage cada vez que cambia
        function guardarFormularioLocal() {
            const datos = {};
            camposFormulario.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (elemento) {
                    datos[campo] = elemento.value;
                }
            });
            
            // Guardar productos
            const productos = [];
            document.querySelectorAll('.producto-item').forEach(item => {
                const nombre = item.querySelector('.producto-nombre')?.value;
                const cantidad = item.querySelector('.producto-cantidad')?.value;
                const precio = item.querySelector('.producto-precio')?.value;
                if (nombre || cantidad || precio) {
                    productos.push({ nombre, cantidad, precio });
                }
            });
            datos.productos = productos;
            
            localStorage.setItem('yavoy_pedido_borrador', JSON.stringify(datos));
        }

        // Restaurar formulario desde localStorage
        function restaurarFormularioLocal() {
            const datosGuardados = localStorage.getItem('yavoy_pedido_borrador');
            if (!datosGuardados) return;
            
            try {
                const datos = JSON.parse(datosGuardados);
                
                // Restaurar campos b√°sicos
                camposFormulario.forEach(campo => {
                    const elemento = document.getElementById(campo);
                    if (elemento && datos[campo]) {
                        elemento.value = datos[campo];
                    }
                });
                
                // Restaurar productos
                if (datos.productos && datos.productos.length > 0) {
                    const container = document.getElementById('productosList');
                    container.innerHTML = datos.productos.map(prod => `
                        <div class="producto-item">
                            <input type="text" placeholder="Nombre del producto" class="producto-nombre" value="${prod.nombre || ''}">
                            <input type="number" placeholder="Cantidad" class="producto-cantidad" min="1" value="${prod.cantidad || 1}">
                            <input type="number" placeholder="Precio" class="producto-precio" step="0.01" min="0" value="${prod.precio || ''}">
                            <button type="button" class="btn btn-danger" onclick="eliminarProducto(this)">-</button>
                        </div>
                    `).join('');
                    
                    // Recalcular total
                    calcularTotal();
                }
                
                // Mostrar notificaci√≥n
                showToast('info', 'üìù Borrador Restaurado', 'Hemos recuperado los datos de tu pedido anterior');
                
            } catch (error) {
                console.error('Error al restaurar formulario:', error);
            }
        }

        // Limpiar borrador despu√©s de env√≠o exitoso
        function limpiarBorradorLocal() {
            localStorage.removeItem('yavoy_pedido_borrador');
        }

        // Agregar event listeners para auto-guardado
        function inicializarAutoGuardado() {
            // Restaurar datos al cargar la p√°gina
            const hayBorrador = localStorage.getItem('yavoy_pedido_borrador');
            if (hayBorrador) {
                // Preguntar si desea restaurar (despu√©s de 1 segundo)
                setTimeout(() => {
                    if (confirm('üîÑ Encontramos un pedido sin terminar. ¬øDeseas recuperar los datos?')) {
                        restaurarFormularioLocal();
                    } else {
                        limpiarBorradorLocal();
                    }
                }, 1000);
            }
            
            // Auto-guardar en cada cambio
            camposFormulario.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (elemento) {
                    elemento.addEventListener('input', () => {
                        guardarFormularioLocal();
                    });
                    elemento.addEventListener('change', () => {
                        guardarFormularioLocal();
                    });
                }
            });
            
            // Auto-guardar productos con delegation
            document.getElementById('productosList')?.addEventListener('input', () => {
                guardarFormularioLocal();
            });
        }

        // Cargar datos iniciales
        cargarComercios();
        cargarSelectorRepartidores();
        inicializarAutoGuardado();
    </script>

    <!-- Contenedor de Notificaciones Toast -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Chatbot Widget -->
    <div class="pedidos-chatbot-widget">
        <button id="btnChatbot" class="pedidos-chatbot-btn" title="Asistente YAvoy" onclick="abrirChatbot()">
            üí¨
        </button>
    </div>

    <!-- Scripts -->
    <script src="js/chatbot-holografico.js"></script>
    <script>
        // Sistema de Notificaciones Toast
        function showToast(type, title, message) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: '‚úÖ',
                info: '‚ÑπÔ∏è',
                warning: '‚ö†Ô∏è',
                error: '‚ùå'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || '‚ÑπÔ∏è'}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <div class="toast-close" onclick="this.parentElement.remove()">√ó</div>
            `;
            
            container.appendChild(toast);
            
            // Auto-remover despu√©s de 5 segundos
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Calculadora de Costo de Env√≠o
        function calcularCostoEnvio() {
            const distanciaKm = parseFloat(document.getElementById('distanciaKm').value) || 1;
            
            // C√°lculo: $1000 por el primer km + $100 por cada 100m adicionales
            let costo = 1000; // Primer kil√≥metro
            
            if (distanciaKm > 1) {
                const kmAdicionales = distanciaKm - 1;
                const metros = kmAdicionales * 1000;
                const incrementos = Math.ceil(metros / 100);
                costo += incrementos * 100;
            }
            
            const costoRepartidor = Math.round(costo * 0.85);
            
            // Mostrar resultado
            document.getElementById('costoResult').style.display = 'flex';
            document.getElementById('costoTotal').textContent = `$${costo.toLocaleString()}`;
            document.getElementById('costoRepartidor').textContent = `$${costoRepartidor.toLocaleString()}`;
            
            // Mostrar f√≥rmula
            if (distanciaKm <= 1) {
                document.getElementById('costoFormula').textContent = `1 km = $1000`;
            } else {
                const adicional = costo - 1000;
                document.getElementById('costoFormula').textContent = `$1000 (1km) + $${adicional.toLocaleString()} (${(distanciaKm-1).toFixed(1)} km)`;
            }
            
            showToast('info', 'üí∞ Costo Estimado', `Distancia: ${distanciaKm} km ‚Ä¢ Total: $${costo.toLocaleString()} ‚Ä¢ Repartidor recibe: $${costoRepartidor.toLocaleString()} (85%)`);
        }

        // Recalcular total de productos
        function calcularTotal() {
            let total = 0;
            document.querySelectorAll('.producto-item').forEach(item => {
                const cantidad = parseFloat(item.querySelector('.producto-cantidad')?.value) || 0;
                const precio = parseFloat(item.querySelector('.producto-precio')?.value) || 0;
                total += cantidad * precio;
            });
            const totalInput = document.getElementById('total');
            if (totalInput) {
                totalInput.value = total.toFixed(2);
            }
        }

        // Renderizar Timeline de Progreso
        function renderizarTimeline(estado) {
            const estados = ['pendiente', 'aceptado', 'en-camino', 'entregado'];
            const iconos = {
                'pendiente': 'üìã',
                'aceptado': '‚úÖ',
                'en-camino': 'üö¥',
                'entregado': 'üéâ'
            };
            const labels = {
                'pendiente': 'Pendiente',
                'aceptado': 'Aceptado',
                'en-camino': 'En Camino',
                'entregado': 'Entregado'
            };
            
            const estadoIndex = estados.indexOf(estado);
            const progreso = estadoIndex >= 0 ? ((estadoIndex + 1) / estados.length) * 100 : 0;
            
            let html = `
                <div class="pedido-timeline">
                    <h4 style="margin: 0 0 10px 0; color: var(--color-primario); font-size: 14px;">üìç Estado del Pedido</h4>
                    <div class="timeline-steps">
                        <div class="timeline-line">
                            <div class="timeline-line-progress" style="width: ${progreso}%"></div>
                        </div>
            `;
            
            estados.forEach((est, index) => {
                const isActive = est === estado;
                const isCompleted = index < estadoIndex;
                const className = `timeline-step ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}`;
                
                html += `
                    <div class="${className}">
                        <div class="timeline-icon">${iconos[est]}</div>
                        <div class="timeline-label">${labels[est]}</div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }
    </script>
    <script>
        // Inicializar chatbot
        document.getElementById('btnChatbot').addEventListener('click', () => {
            if (typeof toggleChatbot === 'function') {
                toggleChatbot();
            } else {
                alert('Asistente cliente en l√≠nea. ¬øEn qu√© puedo ayudarte?');
            }
        });

        // Hover effect para el bot√≥n de chatbot
        document.getElementById('btnChatbot').addEventListener('mouseenter', (e) => {
            e.target.style.transform = 'scale(1.1)';
            e.target.style.boxShadow = '0 12px 40px rgba(6, 182, 212, 0.4)';
        });

        document.getElementById('btnChatbot').addEventListener('mouseleave', (e) => {
            e.target.style.transform = 'scale(1)';
            e.target.style.boxShadow = '0 8px 30px rgba(6, 182, 212, 0.3)';
        });
    </script>
</body>
</html>
